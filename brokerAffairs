USE [MicroclearLight_July23]
GO
/****** Object:  StoredProcedure [etrade].[Sp_SubBrokerDetailsForEservices]    Script Date: 5/22/2024 11:32:10 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--exec etrade.Sp_getBrokerDetailsForEservices @Userid='1536485',@orgid=39043,@requestNumber=NULL,@ReferenceProfile='BRSISSUANCEDOCS',@lang='eng',@Serviceid=17,@mobileUserId=77,@RequestedForMobileUserid=0,@ExamReq=0,@ExamPassedBrokerOnly=NULL,@ChildOrgId= 
 
--NULL    
    
--exec etrade.Sp_getBrokerDetailsForEservices @Userid='1536485',    
--@orgid=39043,@requestNumber=NULL,@ReferenceProfile='BRSISSUANCEDOCS',@lang='eng',@Serviceid=17,@mobileUserId=77,    
--@RequestedForMobileUserid=0,@ExamReq=0,@ExamPassedBrokerOnly=NULL,@ChildOrgId=NULL    
  
create PROCEDURE [etrade].[Sp_SubBrokerDetailsForEservicesRama2]  
    (  
    @OrganizationIDS varchar(1000)='',  
    @Userid varchar(200)='',  
    @civilid varchar(200)='',  
    @BrokerType varchar(200)='',  
    @status varchar(200)='',  
    @Tradelicenseno varchar(200)='',  
    @serviceid int =0  
)  
AS                
BEGIN --1 
--rama new 
   declare @LegalEntity int  
  
    set @LegalEntity=(select legalentity  
    from etrade.MobileUser  
    where userid=@Userid) 
	print(@LegalEntity)
    -- select * from etrade.Eservices             
    DECLARE @stateid TABLE (list varchar(500))  
  
    --print(@serviceid);  
    IF (@serviceid = 2) ----Request For Renewing  Broker License  
 BEGIN --2  
  INSERT INTO @stateid  
  VALUES ('OrganizationsModifyState')  
   ,('OrganizationsCreatedState')  
   ,('OrganizationsNotActivatedState')  
   , ('DRPeopleDeActivatedState'),    --qasem  qasem4
   ('DRPeopleCreatedState')  
   --qasem;            
 END --2  
  
    IF (@serviceid = 12) --Deactivate Broker License Request  
 BEGIN --3  
  PRINT ('IN')  
  
  INSERT INTO @stateid  
  -- VALUES ('OrganizationsModifyState'),('OrganizationsCreatedState');            
  VALUES ('OrganizationsModifyState')  
   ,('OrganizationsCreatedState')  
   ,  
   --  ('DRPeopleDeActivatedState'),    --qasem  
   ('DRPeopleCreatedState');  
   --qasem        
   --VALUES ('OrganizationsCreatedState');            
 END --3  
  
  
    IF (@serviceid = 13) --Broker License Cancellation Request  
 BEGIN --4  
  PRINT ('IN')  
  
  INSERT INTO @stateid  
  VALUES ('OrganizationsModifyState')  
   ,('OrganizationsCreatedState')  
   ,('OrganizationsNotActivatedState')  
   ,('DRPeopleDeActivatedState')  
   ,--qasem3  
   ('DRPeopleCreatedState')  
   --qasem ;  
 END --4  
  
 IF (@serviceid = 14) --Broker Transfer Request  
 BEGIN --5  
  PRINT ('IN')  
  
  -- added nto activated state             
  INSERT INTO @stateid  
  VALUES ('OrganizationsCancelledState')  
 END --5  
  
  
    IF (  
  @serviceid = 15  
  OR @serviceid = 16  
  )  
 BEGIN --6  
  PRINT ('IN')  
  
  INSERT INTO @stateid  
  VALUES ('OrganizationsModifyState')  
   ,('OrganizationsCreatedState');  
 END --6  
  
  
    --qasem  
   IF (@serviceid = 16) --Print Lost Broker License  Card Request  
 BEGIN --7  
  INSERT INTO @stateid  
  VALUES ('DRPeopleCreatedState');  
 END --7  
  
    --end qasem  
  
    --qasem  
 /*  
 Release Bank Guarantee - Revenue Control,  
 Good conduct and behavior- General Directorate of Criminal Evidence,  
 Change Job Title and Renew Residency- General Authority for Manpower,  
 Change Job Title and Transfer Residency- General Authority for Manpower,  
 Residency Renew- General Authority for Manpower,  
 Change Job Title- General Authority for Manpower,  
 Change Job Title- With Broker License- General Authority for Manpower  
 */  
 	--qasem4 added 30
 IF (@serviceid IN (24,25,27,28,29,30,31,32)) --(20,21,22,23,26,33) General Broker Only        
 BEGIN --8  
  INSERT INTO @stateid  
  VALUES  
	('DRPeopleDeActivatedState'), --qasem4 added
   ('DRPeopleCreatedState');  
 END --8  

    --end qasem  
   
 /*  
 Cancel Commercial License -Ministry of Commerce and Industry,  
 Issue Commercial License- Ministry of Commerce and Industry,  
 Change Commercial License Address Letter - Ministry of Commerce and Industry,  
 Change Commercial License Business - Ministry of Commerce and Industry,  
 Release Bank Guarantee - Revenue Control,  
 Good conduct and behavior- General Directorate of Criminal Evidence,  
 Renew Commercial License - Ministry of Commerce and Industry,  
 Change Job Title and Renew Residency- General Authority for Manpower,  
 Change Job Title and Transfer Residency- General Authority for Manpower,  
 Residency Renew- General Authority for Manpower,  
 Residency Transfer- General Authority for Manpower,  
 Change Job Title- General Authority for Manpower,  
 Change Job Title- With Broker License- General Authority for Manpower,  
 Deactivate Commercial License- Death- Ministry of Commerce and Industry  
 */  

 IF (@serviceid IN (24) )  -- rama new remove 20 /21/22/23/25/26 and 27 to 33
  
 BEGIN --9  
  INSERT INTO @stateid  
  VALUES ('OrganizationsModifyState')  
   ,('OrganizationsCreatedState')  ,('OrganizationsNotActivatedState');  
 END --9  
  -- rama new add only not active broker for service 20 and 27 to 33
  IF (@serviceid IN (20,27,28,29,30,31,32,33) )  
  
 BEGIN  
  INSERT INTO @stateid  
  VALUES ('OrganizationsModifyState')  
   ,('OrganizationsCreatedState')  ,('OrganizationsNotActivatedState');  
 END  
   -- rama new add only  active broker for services 21/22/23/25/26

 IF (@serviceid IN (21,22,23,25,26))  
  
 BEGIN 
  INSERT INTO @stateid  
  VALUES ('OrganizationsModifyState')  
   ,('OrganizationsCreatedState')  
   ;  
 END 
 IF (@serviceid IN (24)) --Release Bank Guarantee - Revenue Control  
 BEGIN --10  
  INSERT INTO @stateid  
  VALUES ('OrganizationsCancelledState')  
   ,('OrganizationsTransferredState');  
 END --10    
  
  
    
  
    --print(@LegalEntity);  
    -- print(@Userorgid);  
    -- exec etrade.GETUserAssociatedOrganizationsForBrs '150'      
  
    if(@LegalEntity=2)            
 BEGIN --11  
  CREATE TABLE #TEMP (outputid VARCHAR(400));  
  
  -- Insert the output of stored procedures into temp table            
  INSERT INTO #TEMP  
  EXEC etrade.Usp_MApp_GetAssociatedOrganizationsUsingOrgClearanceFileNumber @Userid;  

    
  
  IF (@serviceid = 17) --Broker License Issuance Request  
  BEGIN --11.1  
   PRINT 'Service ID 17 is in progress'  
  
   SELECT e.RequesterUserId  
    ,T.NAME AS EseBrokerType  
    ,ISNULL(T_ara.NAME, T.NAME) AS BrokerType  
    ,'SubBrokerDetails' AS "TableName"  
    ,ED.RequestForName AS BrokerName  
    ,E.EserviceRequestId AS OrganizationId  
    ,  
    --E.EserviceRequestNumber as encryptedEServiceRequestNumber,            
    E.EserviceRequestNumber AS TradeLicenseNumber  
    ,e.EserviceRequestId  
    ,E.EserviceRequestNumber  
    ,ed.RequestForUserType  
    ,EAD.ClearanceExamType  
    ,eci.ExamResult  
    ,eci.DateModified  
    ,dateadd(month, - 24, getdate())  
    ,*  
   FROM ExamCandidateInfo ECI  
   INNER JOIN ExamsAnnouncementDetails EAD ON ECI.ExamsAnnouncementDetailsId = EAD.ExamsAnnouncementDetailsId  
   INNER JOIN ExamsAnnouncements EA ON EAD.ExamsAnnouncementId = EA.ExamsAnnouncementId  
   INNER JOIN etrade.EServiceRequests E ON E.EserviceRequestId = ECI.EServiceRequestId  
   INNER JOIN etrade.EServiceRequestsDetails ED ON E.EserviceRequestId = ED.EserviceRequestId  
   INNER JOIN Types T ON t.TypeId = ed.RequestForUserType  
   LEFT JOIN Types_ara T_ara ON T.TypeId = T_ara.TypeId  
   WHERE e.RequesterUserId = @Userid  
    AND eci.ExamResult = (  
     SELECT typeid  
     FROM Types  
     WHERE NAME = 'passed the exam'  
      AND StateId = 'EserviceExamResultsTypesCreatedState'  
     )  
	 	 AND ECI.StateId ='ExamCandidateInfoApprovedState' -- rama Kits-54372

    AND eci.DateModified >= dateadd(month, - 24, getdate())  
    /*AND eci.DateModified >= (case when ED.RequestForUserType=33224591 then dateadd(month, - 36, getdate())    
    else dateadd(month, - 12, getdate()) end)*/  
    AND e.EServiceRequestId NOT IN (  
     SELECT isnull(OrganizationId, 0)  
     FROM etrade.EServiceRequestsDetails  
     WHERE RequestServicesId = 17  
      AND StateId IN (  
       'EServiceRequestDetailsProceedState'  
       ,'EServiceRequestDetailsCompletedState'  
       ,'EServicesRequestDetailsSubmittedState'  
       ,'EServiceRequestDetailsReSubmittedState'  
       )  
     )  
    -- and StateId  in ('EServiceRequestSubmittedState','EServiceRequestCreatedState'))      
    AND ED.CIVILID NOT IN (  
     SELECT CIVILID  
     FROM ETRADE.ESERVICEREQUESTSDETAILS  
     WHERE requestERuserid = @userid  
      AND RequestServicesId = 17  
      AND STATEID NOT IN (  
       'EServicesRequestDetailsDeletedState'  
       ,'EServiceRequestDetailsFinalRejectedState'  
       ) -- rama final rejected  
     )  
  END --11.1  
  ELSE  
  BEGIN --11.2  
   EXEC etrade.Usp_MApp_GetAssociatedOrganizationsUsingOrgClearanceFileNumber @Userid;  
  
   if (@@ROWCOUNT!='0')   --qasem    qasem4     
   --if (1=1)            
   BEGIN --11.3  
    /*  
    Cancel Commercial License -Ministry of Commerce and Industry  
    Issue Commercial License- Ministry of Commerce and Industry  
    Change Commercial License Address Letter - Ministry of Commerce and Industry  
    Change Commercial License Business - Ministry of Commerce and Industry  
    Release Bank Guarantee - Revenue Control  
    Good conduct and behavior- General Directorate of Criminal Evidence  
    Renew Commercial License - Ministry of Commerce and Industry  
    Change Job Title and Renew Residency- General Authority for Manpower  
    Change Job Title and Transfer Residency- General Authority for Manpower  
    Residency Renew- General Authority for Manpower  
    Residency Transfer- General Authority for Manpower  
    Change Job Title- General Authority for Manpower  
    Change Job Title- With Broker License- General Authority for Manpower  
    Deactivate Commercial License- Death- Ministry of Commerce and Industry  
    */  
    IF (@serviceid IN (20,21,22,23,24,25,26,27,28,29,30,31,32,33))  
    BEGIN --11.4  
	print('general broker only 0');
     /*  
     Cancel Commercial License -Ministry of Commerce and Industry  
     Issue Commercial License- Ministry of Commerce and Industry  
     Change Commercial License Address Letter - Ministry of Commerce and Industry  
     Change Commercial License Business - Ministry of Commerce and Industry  
     Renew Commercial License - Ministry of Commerce and Industry  
     Deactivate Commercial License- Death- Ministry of Commerce and Industry  
     */  
     IF (@serviceid IN (20,21,22,23,26,33)) -- General Broker Only       
     BEGIN --11.5  
      (  
        SELECT DISTINCT o.StateId  
         ,SO.ChildOrgId  
         ,SO.MainOrgId  
         ,isnull(so.ChildOrgId, O.OrganizationId) 'OrgId'  
         ,isnull(so.ChildOrgId, O.OrganizationId) 'OrganizationId'  
         ,'SubBrokerDetails' AS "TableName"  
         ,BOD.CivilId  
         ,CASE BBD.StateId  
          WHEN 'BrokBGDetailActivatedState'  
           THEN 'ACTIVE'  
          WHEN 'BrokBGDetailDeActivatedState'  
           THEN 'DEACTIVE'  
          ELSE 'INACTIVE'  
          END AS BGStatus  
         ,CASE O.StateId  
          WHEN 'OrganizationsCreatedState'  
           THEN 'ACTIVE'  
          WHEN 'OrganizationsModifyState'  
           THEN 'ACTIVE'  
          WHEN 'OrganizationsNotActivatedState'  
           THEN 'DEACTIVE'  
          WHEN 'OrganizationsTransferredState'  
           THEN 'TRANSFERRED'  
          ELSE 'INACTIVE'  
          END AS AccountStatus  
        -- ,u.AccountStatus AS testaccnt  qasem2024
         ,BrokerType.TypeId  
         ,O.TradeLicenseNumber  
         ,ISNULL(sb.NAME, O.NAME) AS BrokerName  
         ,BLD.BrokerFileNumber  
         ,ISNULL(T.NAME, BrokerType.NAME) AS BrokerType  
         ,BrokerType.NAME AS EseBrokerType  
         ,ISNULL(BBD.BGNo, '--') AS BankGuaranteeNo  
         ,BBD.BGExpiryDt AS BankGuaranteeExpiryDate  
         ,CONVERT(VARCHAR, BBD.BGExpiryDt, 103) AS 'BankGuaranteeExpiryDatee' -- Abdul Karim            
         --,*         
         ,CONVERT(VARCHAR, BLD.DtOfExpiry, 103) AS LicenseNumberExpiryDate  
        FROM Organizations O  
        LEFT JOIN BrokerOrgDetails BOD ON BOD.BrokerOrgId = O.OrganizationId  
        INNER JOIN organizations sb ON BOD.BrokerOrgId = sb.OrganizationId  
        LEFT JOIN DRpeople DR ON DR.DROrganizationId = BOD.BrokerOrgId --omar  
        LEFT JOIN BrokBGDetails BBD ON BBD.BrokerOrgId = DR.DRPeopleId  
       -- AND BBD.StateId NOT IN ('BrokBGDetailDeActivatedState')  
		AND BBD.StateId IN ('BrokBGDetailActivatedState','BrokBGDetailExpiredState')   --qasem2024
        LEFT JOIN SubOrg SO ON SO.ChildOrgId = BOD.BrokerOrgId -- and SO.ChildOrgId  in (select * from #TEMP)      
        LEFT JOIN Types BrokerType ON BOD.BrokerTypeId = BrokerType.TypeId  
        LEFT JOIN Types_ara T ON BrokerType.TypeId = T.TypeId  
        LEFT JOIN BrokLicenseDetails BLD ON O.OrganizationId = BLD.BrokerOrgId  
        LEFT JOIN DataProfileClassWorkflowStates W ON BOD.StateId = W.StateId  
        LEFT JOIN DataProfileClassWorkflowStates_ara WA ON W.StateId = WA.StateId  
        LEFT JOIN Organizations_ara OA ON OA.OrganizationId = O.OrganizationId  
        LEFT JOIN users U ON u.OrganizationId = o.OrganizationId  
        WHERE O.OrganizationId IN (  
          SELECT *  
          FROM etrade.[fnSplitbigint](@OrganizationIDS)  
          ) --( @OrganizationIDS)--.REPLACE('''',''))            
         AND (  
          (  
           ISNULL(@civilid, '') <> ''  
           AND BOD.CivilId = @civilid  
           )  
          OR (  
           ISNULL(@civilid, '') = ''  
           AND 1 = 1  
           )  
          )  
         AND (  
          (  
           ISNULL(@Tradelicenseno, '') <> ''  
           AND O.TradeLicenseNumber = @Tradelicenseno  
           )  
          OR (  
           ISNULL(@Tradelicenseno, '') = ''  
           AND 1 = 1  
           )  
          )  
         AND (  
          (  
           ISNULL(@BrokerType, '') <> ''  
           AND BrokerType.NAME = @BrokerType  
           )  
          OR (  
           ISNULL(@BrokerType, '') = ''  
           AND 1 = 1  
           )  
          )  
         AND isnull(so.ChildOrgId, O.OrganizationId) IN (  
          SELECT *  
          FROM #TEMP  
          )  
         AND o.StateId IN (  
          SELECT list  
          FROM @stateid  
          )  
         AND isnull(so.ChildOrgId, O.OrganizationId) NOT IN (  
          SELECT OrganizationId  
          FROM etrade.EServiceRequestsDetails  
          WHERE StateId IN (  
            'EServiceRequestDetailsProceedState'  
            ,'EServicesRequestDetailsSubmittedState'  
            ,'EServicesRequestDetailsCreatedState'  
            )  
           AND RequestServicesId = @serviceid  
           AND RequesterUserId = @Userid  
          )  
        )  
     END --11.5  
  
     /*  
     Release Bank Guarantee - Revenue Control  
     Good conduct and behavior- General Directorate of Criminal Evidence  
     Change Job Title and Renew Residency- General Authority for Manpower  
     Residency Renew- General Authority for Manpower  
     Residency Transfer- General Authority for Manpower  
     Change Job Title- With Broker License- General Authority for Manpower  
     */  
     IF (@serviceid IN (24,25,27,29,30,32)) -- All Brokers       
     BEGIN --11.6  
      PRINT ('comehere and chk');  
  
      /*  
      Release Bank Guarantee - Revenue Control  
      Good conduct and behavior- General Directorate of Criminal Evidence  
      Residency Renew- General Authority for Manpower  
      Residency Transfer- General Authority for Manpower  
      */  
      IF (@serviceid IN (24,25,29,30))  
      BEGIN --11.7  
       SELECT DISTINCT o.StateId  
        ,SO.ChildOrgId  
        ,SO.MainOrgId  
        ,isnull(so.ChildOrgId, O.OrganizationId) 'OrgId'  
        ,isnull(so.ChildOrgId, O.OrganizationId) 'OrganizationId'  
        ,'SubBrokerDetails' AS "TableName"  
        ,BOD.CivilId  
        ,CASE BBD.StateId  
         WHEN 'BrokBGDetailActivatedState'  
          THEN 'ACTIVE'  
         WHEN 'BrokBGDetailDeActivatedState'  
          THEN 'DEACTIVE'  
         ELSE 'INACTIVE'  
         END AS BGStatus  

       -- ,CASE O.StateId  qasem2024
        ,CASE sb.StateId  --qasem2024
         WHEN 'OrganizationsCreatedState'  
          THEN 'ACTIVE'  
         WHEN 'OrganizationsModifyState'  
          THEN 'ACTIVE'  
         WHEN 'OrganizationsNotActivatedState'  
          THEN 'DEACTIVE'  
         WHEN 'OrganizationsTransferredState'  
          THEN 'TRANSFERRED'  
         ELSE 'INACTIVE'  
         END AS AccountStatus  

      --  ,u.AccountStatus AS testaccnt  qasem2024
        ,BrokerType.TypeId  
 -- ,O.TradeLicenseNumber  
	         ,bld.LicenseNo as TradeLicenseNumber  --qasem7-12
			 ,  
        -- ISNULL(OA.Name,O.NAME) AS BrokerName,                
        sb.NAME AS BrokerName  
        ,BLD.BrokerFileNumber  
        ,ISNULL(T.NAME, BrokerType.localdescription) AS BrokerType  
        ,BrokerType.NAME AS EseBrokerType  
        -- ISNULL(T.NAME, BrokerType.NAME) AS BrokerType,BrokerType.Name as EseBrokerType,            
        ,ISNULL(BBD.BGNo, '--') AS BankGuaranteeNo  
        ,BBD.BGExpiryDt AS BankGuaranteeExpiryDate  
        ,CONVERT(VARCHAR, BBD.BGExpiryDt, 103) AS 'BankGuaranteeExpiryDatee' -- Abdul Karim            
        --,*                
        ,CONVERT(VARCHAR, BLD.DtOfExpiry, 103) AS LicenseNumberExpiryDate  
        ,'' AS PersonalId  
       FROM Organizations O -- Parent Organizations and File Number      
       LEFT JOIN users U ON u.OrganizationId = o.OrganizationId  
       LEFT JOIN Organizations_ara OA ON OA.OrganizationId = O.OrganizationId  
       INNER JOIN SubOrg SO ON O.OrganizationId = SO.MainOrgId  
        AND SO.ChildOrgId IN (  
         SELECT *  
         FROM #TEMP  
         )  
       INNER JOIN BrokerOrgDetails BOD ON SO.ChildOrgId = BOD.BrokerOrgId -- Special Broker      
       INNER JOIN organizations sb ON BOD.BrokerOrgId = sb.OrganizationId  
       LEFT JOIN BrokBGDetails BBD ON BBD.BrokerOrgId = bod.BrokerOrgId  
       -- AND BBD.StateId NOT IN ('BrokBGDetailDeActivatedState')  
		AND BBD.StateId IN ('BrokBGDetailActivatedState','BrokBGDetailExpiredState')   --qasem2024
       INNER JOIN BrokLicenseDetails BLD ON BLD.BrokerOrgId = SO.ChildOrgId -- Special Broker License Details and File Number      
       INNER JOIN BrokerImporter BI ON BI.BrokerOrgId = SO.ChildOrgId  
       INNER JOIN Types BrokerType ON BrokerType.TypeId = bod.BrokerTypeId  
       LEFT JOIN Types_ara T ON BrokerType.TypeId = T.TypeId  
       --where o.OrganizationId in (SELECT outputid FROM #TEMP)            
       WHERE /*O.OrganizationId IN (@OrganizationIDS) --omar --mohan 
        AND*/ o.StateId IN (  
         SELECT list  
         FROM @stateid  
         )  
        AND isnull(SO.ChildOrgId, 0) NOT IN (  
         SELECT OrganizationId  
         FROM etrade.EServiceRequestsDetails  
         WHERE StateId IN (  
           'EServiceRequestDetailsProceedState'  
           ,'EServicesRequestDetailsSubmittedState'  
           ,'EServicesRequestDetailsCreatedState'  
           ,'EServiceRequestDetailsReSubmittedState'  
           )  
          AND RequestServicesId = @serviceid  
          AND RequesterUserId = @Userid  
         )  
       -- start omar  
       
       UNION  
       
       SELECT DISTINCT o.StateId  
        ,NULL  
        ,NULL  
        ,O.OrganizationId 'OrgId'  
        ,O.OrganizationId 'OrganizationId'  
        ,'SubBrokerDetails' AS "TableName"  
        ,BOD.CivilId  
        ,CASE BBD.StateId  
         WHEN 'BrokBGDetailActivatedState'  
          THEN 'ACTIVE'  
         WHEN 'BrokBGDetailDeActivatedState'  
          THEN 'DEACTIVE'  
         ELSE 'INACTIVE'  
         END AS BGStatus  

          --qasem2024 
	   ,CASE  DR.StateId  
        WHEN 'DRPeopleCreatedState'  
         THEN 'ACTIVE'  
        WHEN 'DRPeopleDeActivatedState'  
         THEN 'DEACTIVE'  
        ELSE 'INACTIVE'  
        END AS AccountStatus  
		
       -- ,u.AccountStatus AS testaccnt  qasem2024
        ,BrokerType.TypeId  
 -- ,O.TradeLicenseNumber  
	         ,DR.BrokerLicenseNo as TradeLicenseNumber  --qasem7-12
			 ,  
        -- ISNULL(OA.Name,O.NAME) AS BrokerName,                
        DR.BrokerEngFirstName + ' ' + DR.BrokerEngLastName AS BrokerName  
        ,BLD.BrokerFileNumber  
        ,ISNULL(T.NAME, BrokerType.localdescription) AS BrokerType  
        ,BrokerType.NAME AS EseBrokerType  
        -- ISNULL(T.NAME, BrokerType.NAME) AS BrokerType,BrokerType.Name as EseBrokerType,            
        ,ISNULL(BBD.BGNo, '--') AS BankGuaranteeNo  
        ,BBD.BGExpiryDt AS BankGuaranteeExpiryDate  
        ,CONVERT(VARCHAR, BBD.BGExpiryDt, 103) AS 'BankGuaranteeExpiryDatee' -- Abdul Karim            
        --,*                
        ,CONVERT(VARCHAR, DR.BrokerExpiryDate, 103) AS LicenseNumberExpiryDate  --7-12 qasem
        ,DR.PersonalId --omar  
       FROM Organizations O -- Parent Organizations and File Number      
       LEFT JOIN users U ON u.OrganizationId = o.OrganizationId  
       LEFT JOIN Organizations_ara OA ON OA.OrganizationId = O.OrganizationId  
       LEFT JOIN DRPeople DR ON DR.PersonalId = U.PersonalId  
       INNER JOIN BrokerOrgDetails BOD ON DR.DROrganizationId = BOD.BrokerOrgId  
       INNER JOIN organizations sb ON BOD.BrokerOrgId = sb.OrganizationId  
       LEFT JOIN BrokBGDetails BBD ON BBD.BrokerOrgId = DR.DRPeopleId  
       -- AND BBD.StateId NOT IN ('BrokBGDetailDeActivatedState')    --qasem2024
		AND BBD.StateId IN ('BrokBGDetailActivatedState','BrokBGDetailExpiredState')   --qasem2024
       INNER JOIN BrokLicenseDetails BLD ON BLD.BrokerOrgId = O.OrganizationId  
       INNER JOIN Types BrokerType ON BrokerType.TypeId = bod.BrokerTypeId  
       LEFT JOIN Types_ara T ON BrokerType.TypeId = T.TypeId  
       --where o.OrganizationId in (SELECT outputid FROM #TEMP)            
       --where DR.DROrganizationId = 1772991 and  
       WHERE DR.DRBrokerType = [dbo].[KWConstantfn]('GBL_Types.TYPE.DRBroker')  
        AND DR.DROrganizationId IN (  
         SELECT *  
         FROM etrade.[fnSplitbigint](@OrganizationIDS)  
         )  
        AND DR.StateId IN (  
         SELECT list  
         FROM @stateid  
         )  
        --qasem  
        AND DR.PersonalId NOT IN (  
         SELECT OrganizationId  
         FROM etrade.EServiceRequestsDetails  
         WHERE StateId IN (  
           'EServiceRequestDetailsProceedState'  
           ,'EServicesRequestDetailsSubmittedState'  
           ,'EServicesRequestDetailsCreatedState'  
           ,'EServiceRequestDetailsReSubmittedState'  
           )  
          AND RequestServicesId = @serviceid  
          AND RequesterUserId = @Userid  
         )  
       ORDER BY BrokerType.TypeId  
        -- end omar  
      END --11.7  
  
      /* check belo case for later       
       SELECT DISTINCT o.StateId  
       ,SO.ChildOrgId  
       ,SO.MainOrgId  
       ,isnull(so.ChildOrgId, O.OrganizationId) 'OrgId'  
       ,isnull(so.ChildOrgId, O.OrganizationId) 'OrganizationId'  
       ,'SubBrokerDetails' AS "TableName"  
       ,BOD.CivilId  
       ,CASE BBD.StateId  
        WHEN 'BrokBGDetailActivatedState'  
         THEN 'ACTIVE'  
        WHEN 'BrokBGDetailDeActivatedState'  
         THEN 'DEACTIVE'  
        ELSE 'INACTIVE'  
        END AS BGStatus  
       ,CASE O.StateId  
        WHEN 'OrganizationsCreatedState'  
         THEN 'ACTIVE'  
        WHEN 'OrganizationsModifyState'  
         THEN 'ACTIVE'  
        WHEN 'OrganizationsNotActivatedState'  
         THEN 'DEACTIVE'  
        ELSE 'INACTIVE'  
        END AS AccountStatus  
       ,u.AccountStatus AS testaccnt  
       ,BrokerType.TypeId  
       ,O.TradeLicenseNumber  
       ,ISNULL(OA.NAME, O.NAME) AS BrokerName  
       ,BLD.BrokerFileNumber  
       ,ISNULL(T.NAME, BrokerType.NAME) AS BrokerType  
       ,BrokerType.NAME AS EseBrokerType  
       ,ISNULL(BBD.BGNo, '--') AS BankGuaranteeNo  
       ,BBD.BGExpiryDt AS BankGuaranteeExpiryDate  
       ,CONVERT(VARCHAR, BBD.BGExpiryDt, 103) AS 'BankGuaranteeExpiryDatee' -- Abdul Karim            
       --,*                
       ,CONVERT(VARCHAR, BLD.DtOfExpiry, 103) AS LicenseNumberExpiryDate  
      FROM Organizations O  
      LEFT JOIN BrokerOrgDetails BOD ON BOD.BrokerOrgId = O.OrganizationId  
      LEFT JOIN BrokBGDetails BBD ON BBD.BrokerOrgId = BOD.BrokerOrgId  
       AND BBD.StateId NOT IN ('BrokBGDetailDeActivatedState')  
      LEFT JOIN SubOrg SO ON SO.ChildOrgId = BOD.BrokerOrgId  
      LEFT JOIN Types BrokerType ON BOD.BrokerTypeId = BrokerType.TypeId  
      LEFT JOIN Types_ara T ON BrokerType.TypeId = T.TypeId  
      LEFT JOIN BrokLicenseDetails BLD ON O.OrganizationId = BLD.BrokerOrgId  
      LEFT JOIN DataProfileClassWorkflowStates W ON BOD.StateId = W.StateId  
      LEFT JOIN DataProfileClassWorkflowStates_ara WA ON W.StateId = WA.StateId  
      LEFT JOIN Organizations_ara OA ON OA.OrganizationId = O.OrganizationId  
      LEFT JOIN users U ON u.OrganizationId = o.OrganizationId  
      WHERE O.OrganizationId IN (  
        SELECT *  
        FROM etrade.[fnSplitbigint](@OrganizationIDS)  
        ) --( @OrganizationIDS)--.REPLACE('''',''))            
       AND (  
        (  
         ISNULL(@civilid, '') <> ''  
         AND BOD.CivilId = @civilid  
         )  
        OR (  
         ISNULL(@civilid, '') = ''  
         AND 1 = 1  
         )  
        )  
       AND (  
        (  
         ISNULL(@Tradelicenseno, '') <> ''  
         AND O.TradeLicenseNumber = @Tradelicenseno  
         )  
        OR (  
         ISNULL(@Tradelicenseno, '') = ''  
         AND 1 = 1  
         )  
        )  
       AND (  
        (  
         ISNULL(@BrokerType, '') <> ''  
         AND BrokerType.NAME = @BrokerType  
         )  
        OR (  
         ISNULL(@BrokerType, '') = ''  
         AND 1 = 1  
         )  
        )  
       AND o.StateId IN (  
        SELECT list  
        FROM @stateid  
        )  
       --and  isnull(so.ChildOrgId,O.OrganizationId) in (select * from #TEMP)          
       AND isnull(so.ChildOrgId, O.OrganizationId) IN (  
        SELECT *  
        FROM #TEMP  
        )  
       AND isnull(so.ChildOrgId, O.OrganizationId) NOT IN (  
        SELECT OrganizationId  
        FROM etrade.EServiceRequestsDetails  
        WHERE StateId IN (  
          'EServiceRequestDetailsProceedState'  
          ,'EServicesRequestDetailsSubmittedState'  
          ,'EServicesRequestDetailsCreatedState'  
          )  
         AND RequestServicesId = @serviceid  
         AND RequesterUserId = @Userid  
        )  
  
      UNION --all            
  
      SELECT DISTINCT o.StateId  
       ,SO.ChildOrgId  
       --,isnull(u.UserId,'') as userid            
       ,SO.MainOrgId  
       ,isnull(so.ChildOrgId, O.OrganizationId) 'OrgId'  
       ,isnull(so.ChildOrgId, O.OrganizationId) 'OrganizationId'  
       ,'SubBrokerDetails' AS "TableName"  
       ,BOD.CivilId  
       ,CASE BBD.StateId  
        WHEN 'BrokBGDetailActivatedState'  
         THEN 'ACTIVE'  
        WHEN 'BrokBGDetailDeActivatedState'  
         THEN 'DEACTIVE'  
        ELSE 'INACTIVE'  
        END AS BGStatus  
       ,CASE O.StateId  
        WHEN 'OrganizationsCreatedState'  
         THEN 'ACTIVE'  
        WHEN 'OrganizationsNotActivatedState'  
         THEN 'DEACTIVE'  
        WHEN 'OrganizationsModifyState'  
         THEN 'ACTIVE'  
        ELSE 'INACTIVE'  
        END AS AccountStatus  
       ,u.AccountStatus AS testaccnt  
       ,BrokerType.TypeId  
       ,O.TradeLicenseNumber  
       ,ISNULL(OA.NAME, O.NAME) AS BrokerName  
       ,BLD.BrokerFileNumber  
       ,ISNULL(T.NAME, BrokerType.NAME) AS BrokerType  
       ,BrokerType.NAME AS EseBrokerType  
       ,ISNULL(BBD.BGNo, '--') AS BankGuaranteeNo  
       ,BBD.BGExpiryDt AS BankGuaranteeExpiryDate  
       ,CONVERT(VARCHAR, BBD.BGExpiryDt, 103) AS 'BankGuaranteeExpiryDatee' -- Abdul Karim            
       -- ,*            
       ,CONVERT(VARCHAR, BLD.DtOfExpiry, 103) AS LicenseNumberExpiryDate  
      FROM Organizations O  
      LEFT JOIN BrokerOrgDetails BOD ON BOD.BrokerOrgId = O.OrganizationId  
      LEFT JOIN BrokBGDetails BBD ON BBD.BrokerOrgId = BOD.BrokerOrgId  
       AND BBD.StateId NOT IN ('BrokBGDetailDeActivatedState')  
      LEFT JOIN SubOrg SO ON SO.ChildOrgId = BOD.BrokerOrgId  
       AND isnull(so.ChildOrgId, O.OrganizationId) IN (  
        SELECT *  
        FROM #TEMP  
        )  
      LEFT JOIN Types BrokerType ON BOD.BrokerTypeId = BrokerType.TypeId  
      LEFT JOIN Types_ara T ON BrokerType.TypeId = T.TypeId  
      LEFT JOIN BrokLicenseDetails BLD ON O.OrganizationId = BLD.BrokerOrgId  
      LEFT JOIN DataProfileClassWorkflowStates W ON BOD.StateId = W.StateId  
      LEFT JOIN DataProfileClassWorkflowStates_ara WA ON W.StateId = WA.StateId  
      LEFT JOIN Organizations_ara OA ON OA.OrganizationId = O.OrganizationId  
      LEFT JOIN users U ON u.OrganizationId = o.OrganizationId  
      WHERE SO.MainOrgId IN (  
        SELECT *  
        FROM etrade.[fnSplitbigint](@OrganizationIDS)  
        ) --( @OrganizationIDS)--.REPLACE('''',''))            
       AND (  
        (  
         ISNULL(@civilid, '') <> ''  
         AND BOD.CivilId = @civilid  
         )  
        OR (  
         ISNULL(@civilid, '') = ''  
         AND 1 = 1  
         )  
        )  
       AND (  
        (  
         ISNULL(@Tradelicenseno, '') <> ''  
         AND O.TradeLicenseNumber = @Tradelicenseno  
         )  
        OR (  
         ISNULL(@Tradelicenseno, '') = ''  
         AND 1 = 1  
         )  
        )  
       AND (  
        (  
         ISNULL(@BrokerType, '') <> ''  
         AND BrokerType.NAME = @BrokerType  
         )  
        OR (  
         ISNULL(@BrokerType, '') = ''  
         AND 1 = 1  
         )  
        )  
       AND o.StateId IN (  
        SELECT list  
        FROM @stateid  
        )  
       AND isnull(so.ChildOrgId, O.OrganizationId) NOT IN (  
        SELECT OrganizationId  
        FROM etrade.EServiceRequestsDetails  
        WHERE StateId IN (  
          'EServiceRequestDetailsProceedState'  
          ,'EServicesRequestDetailsSubmittedState'  
          ,'EServicesRequestDetailsCreatedState'  
          )  
         AND RequestServicesId = @serviceid  
         AND RequesterUserId = @Userid  
        )  
      --and o.StateId in (@stateid)            
      ORDER BY BrokerType.TypeId;   
      */  
      /*  
      Change Job Title and Renew Residency- General Authority for Manpower  
      Change Job Title- With Broker License- General Authority for Manpower  
      */  
      IF (@serviceid IN (27,32))  
      BEGIN --11.10  
       SELECT DISTINCT o.StateId  
        ,SO.ChildOrgId  
        ,SO.MainOrgId  
        ,isnull(so.ChildOrgId, O.OrganizationId) 'OrgId'  
        ,isnull(so.ChildOrgId, O.OrganizationId) 'OrganizationId'  
        ,'SubBrokerDetails' AS "TableName"  
        ,BOD.CivilId  
        ,CASE BBD.StateId  
         WHEN 'BrokBGDetailActivatedState'  
          THEN 'ACTIVE'  
         WHEN 'BrokBGDetailDeActivatedState'  
          THEN 'DEACTIVE'  
         ELSE 'INACTIVE'  
         END AS BGStatus  

       -- ,CASE O.StateId  qasem2024
        ,CASE sb.StateId  --qasem2024
         WHEN 'OrganizationsCreatedState'  
          THEN 'ACTIVE'  
         WHEN 'OrganizationsModifyState'  
          THEN 'ACTIVE'  
         WHEN 'OrganizationsNotActivatedState'  
          THEN 'DEACTIVE'  
         WHEN 'OrganizationsTransferredState'  
          THEN 'TRANSFERRED'  
         ELSE 'INACTIVE'  
         END AS AccountStatus  
      --  ,u.AccountStatus AS testaccnt  	       --qasem2024 
        ,BrokerType.TypeId  
 -- ,O.TradeLicenseNumber  
	         ,bld.LicenseNo as TradeLicenseNumber  --qasem7-12
			 ,  
        -- ISNULL(OA.Name,O.NAME) AS BrokerName,                
        sb.NAME AS BrokerName  
        ,BLD.BrokerFileNumber  
        ,ISNULL(T.NAME, BrokerType.localdescription) AS BrokerType  
        ,BrokerType.NAME AS EseBrokerType  
        -- ISNULL(T.NAME, BrokerType.NAME) AS BrokerType,BrokerType.Name as EseBrokerType,            
        ,ISNULL(BBD.BGNo, '--') AS BankGuaranteeNo  
        ,BBD.BGExpiryDt AS BankGuaranteeExpiryDate  
        ,CONVERT(VARCHAR, BBD.BGExpiryDt, 103) AS 'BankGuaranteeExpiryDatee' -- Abdul Karim            
        --,*                
        ,CONVERT(VARCHAR, BLD.DtOfExpiry, 103) AS LicenseNumberExpiryDate  
        ,'' AS PersonalId --omar  
       FROM Organizations O -- Parent Organizations and File Number      
       LEFT JOIN users U ON u.OrganizationId = o.OrganizationId  
       LEFT JOIN Organizations_ara OA ON OA.OrganizationId = O.OrganizationId  
       INNER JOIN SubOrg SO ON O.OrganizationId = SO.MainOrgId  
        AND SO.ChildOrgId IN (  
         SELECT *  
         FROM #TEMP  
         )  
       INNER JOIN BrokerOrgDetails BOD ON SO.ChildOrgId = BOD.BrokerOrgId -- Special Broker      
       INNER JOIN organizations sb ON BOD.BrokerOrgId = sb.OrganizationId  
       LEFT JOIN BrokBGDetails BBD ON BBD.BrokerOrgId = bod.BrokerOrgId  
		-- AND BBD.StateId NOT IN ('BrokBGDetailDeActivatedState')  
		AND BBD.StateId IN ('BrokBGDetailActivatedState','BrokBGDetailExpiredState')   --qasem2024
       INNER JOIN BrokLicenseDetails BLD ON BLD.BrokerOrgId = SO.ChildOrgId -- Special Broker License Details and File Number      
       INNER JOIN BrokerImporter BI ON BI.BrokerOrgId = SO.ChildOrgId  
       INNER JOIN Types BrokerType ON BrokerType.TypeId = bod.BrokerTypeId  
       LEFT JOIN Types_ara T ON BrokerType.TypeId = T.TypeId  
       --where o.OrganizationId in (SELECT outputid FROM #TEMP)            
       WHERE /*O.OrganizationId IN (@OrganizationIDS) --omar --mohan 
        AND*/ o.StateId IN (  
         SELECT list  
         FROM @stateid  
         )  
        AND isnull(SO.ChildOrgId, 0) NOT IN (  
         SELECT OrganizationId  
         FROM etrade.EServiceRequestsDetails  
         WHERE StateId IN (  
           'EServiceRequestDetailsProceedState'  
           ,'EServicesRequestDetailsSubmittedState'  
           ,'EServicesRequestDetailsCreatedState'  
           ,'EServiceRequestDetailsReSubmittedState'  
           )  
          AND RequestServicesId = @serviceid  
          AND RequesterUserId = @Userid  
         )  
        AND T.TypeId != 33224591  
       --exclude general broker for service 28,31,27,32    
       --SELECT * FROM types WHERE typeid IN (33224591,33224592,33224593,33237149)--broker types    
       -- start omar  
       
       UNION  
       
       SELECT DISTINCT o.StateId  
        ,NULL  
        ,NULL  
        ,O.OrganizationId 'OrgId'  
        ,O.OrganizationId 'OrganizationId'  
        ,'SubBrokerDetails' AS "TableName"  
        ,BOD.CivilId  
        ,CASE BBD.StateId  
         WHEN 'BrokBGDetailActivatedState'  
          THEN 'ACTIVE'  
         WHEN 'BrokBGDetailDeActivatedState'  
          THEN 'DEACTIVE'  
         ELSE 'INACTIVE'  
         END AS BGStatus  
       
	       --qasem2024 
	   ,CASE  DR.StateId  
        WHEN 'DRPeopleCreatedState'  
         THEN 'ACTIVE'  
        WHEN 'DRPeopleDeActivatedState'  
         THEN 'DEACTIVE'  
        ELSE 'INACTIVE'  
        END AS AccountStatus  

        --,u.AccountStatus AS testaccnt  	       --qasem2024 
        ,BrokerType.TypeId  
 -- ,O.TradeLicenseNumber  
	         ,DR.BrokerLicenseNo as TradeLicenseNumber  --qasem7-12
			 ,  
        -- ISNULL(OA.Name,O.NAME) AS BrokerName,                
        DR.BrokerEngFirstName + ' ' + DR.BrokerEngLastName AS BrokerName  
        ,BLD.BrokerFileNumber  
        ,ISNULL(T.NAME, BrokerType.localdescription) AS BrokerType  
        ,BrokerType.NAME AS EseBrokerType  
        -- ISNULL(T.NAME, BrokerType.NAME) AS BrokerType,BrokerType.Name as EseBrokerType,            
        ,ISNULL(BBD.BGNo, '--') AS BankGuaranteeNo  
        ,BBD.BGExpiryDt AS BankGuaranteeExpiryDate  
        ,CONVERT(VARCHAR, BBD.BGExpiryDt, 103) AS 'BankGuaranteeExpiryDatee' -- Abdul Karim            
        --,*                
        ,CONVERT(VARCHAR, DR.BrokerExpiryDate, 103) AS LicenseNumberExpiryDate  --7-12 qasem
        ,DR.PersonalId  
       FROM Organizations O -- Parent Organizations and File Number      
       LEFT JOIN users U ON u.OrganizationId = o.OrganizationId  
       LEFT JOIN Organizations_ara OA ON OA.OrganizationId = O.OrganizationId  
       LEFT JOIN DRPeople DR ON DR.PersonalId = U.PersonalId  
       INNER JOIN BrokerOrgDetails BOD ON DR.DROrganizationId = BOD.BrokerOrgId  
       INNER JOIN organizations sb ON BOD.BrokerOrgId = sb.OrganizationId  
       LEFT JOIN BrokBGDetails BBD ON BBD.BrokerOrgId = DR.DRPeopleId  
		-- AND BBD.StateId NOT IN ('BrokBGDetailDeActivatedState')  
		AND BBD.StateId IN ('BrokBGDetailActivatedState','BrokBGDetailExpiredState')   --qasem2024
       INNER JOIN BrokLicenseDetails BLD ON BLD.BrokerOrgId = O.OrganizationId  
       INNER JOIN Types BrokerType ON BrokerType.TypeId = bod.BrokerTypeId  
       LEFT JOIN Types_ara T ON BrokerType.TypeId = T.TypeId  
       --where o.OrganizationId in (SELECT outputid FROM #TEMP)            
       WHERE DR.DRBrokerType = [dbo].[KWConstantfn]('GBL_Types.TYPE.DRBroker')  
        AND DR.DROrganizationId IN (  
         SELECT *  
         FROM etrade.[fnSplitbigint](@OrganizationIDS)  
         )  
        AND DR.StateId IN (  
         SELECT list  
         FROM @stateid  
         )  
        --qasem  
        AND DR.PersonalId NOT IN (  
         SELECT OrganizationId  
         FROM etrade.EServiceRequestsDetails  
         WHERE StateId IN (  
           'EServiceRequestDetailsProceedState'  
           ,'EServicesRequestDetailsSubmittedState'  
           ,'EServicesRequestDetailsCreatedState'  
           ,'EServiceRequestDetailsReSubmittedState'  
           )  
          AND RequestServicesId = @serviceid  
          AND RequesterUserId = @Userid  
         )  
       ORDER BY BrokerType.TypeId  
        -- end omar  
      END --11.10  
     END --11.6  
  
     /*  
     Change Job Title and Transfer Residency- General Authority for Manpower  
     Change Job Title- General Authority for Manpower  
     */  
     IF (@serviceid IN (28,31))  
     BEGIN --11.8  
      PRINT 'exampassedstate 1'  
  
      SELECT 'ExamPassedState' StateId  
       ,examcandidateinfoid ChildOrgId  
       ,EAD.ownerorgid MainOrgId  
       ,EAD.ownerorgid 'OrgId'  
       ,EAD.ownerorgid 'OrganizationId'  
       ,'SubBrokerDetails' AS "TableName"  
       ,ED.CivilID CivilId  
       ,  
       --  CASE BBD.StateId           
       --  WHEN 'BrokBGDetailActivatedState' THEN 'ACTIVE'           
       --  WHEN 'BrokBGDetailDeActivatedState' THEN 'DEACTIVE'            
       --  ELSE 'INACTIVE'           
       --END as     
       'ExamPassedState' BGStatus  
       ,  
       --   CASE O.StateId           
       --  WHEN 'OrganizationsCreatedState' THEN 'ACTIVE'           
       --    WHEN 'OrganizationsModifyState' THEN 'ACTIVE'           
       --  WHEN 'OrganizationsNotActivatedState' THEN 'DEACTIVE'            
       --  ELSE           
       --  'INACTIVE'          
       --END AS    
       'ExamPassedState' AccountStatus  
      -- ,'u.AccountStatus' AS testaccnt  qasem2024
       ,'' TypeId  
       ,'' TradeLicenseNumber  
       ,ED.RequestForName AS BrokerName  
       ,'' BrokerFileNumber  
       ,  
       -- ISNULL(T.NAME, BrokerType.NAME) AS BrokerType,BrokerType.Name as EseBrokerType,          
       ISNULL(T_ara.NAME, T.NAME) AS BrokerType  
       ,T.NAME AS EseBrokerType  
       ,NULL AS BankGuaranteeNo  
       ,NULL AS BankGuaranteeExpiryDate  
       ,NULL AS 'BankGuaranteeExpiryDatee' -- Abdul Karim          
       --,*              
       ,NULL AS LicenseNumberExpiryDate  
       ,'' AS PersonalId  
      -- E.eservicerequestid,E.stateid,eservicerequestnumber,E.datecreated,E.datemodified,    
      ----examcandidateinfoid,b.examsannouncementdetailsid,examresult,b.stateid,b.ownerorgid,    
      --exammark,EAD.passinggrade,    
      --CASE  WHEN exammark>=EAD.passinggrade THEN 'PASS' ELSE 'FAIL' END AS 'EXAMSTATUS', ED.PassportNo,ED.PassportExpiryDate,ED.CivilID,    
      --ED.CivilIDExpiryDate,ED.Email,ED.MobileNumber,ED.Address    
      FROM ExamCandidateInfo ECI  
      INNER JOIN ExamsAnnouncementDetails EAD ON ECI.ExamsAnnouncementDetailsId = EAD.ExamsAnnouncementDetailsId  
      INNER JOIN ExamsAnnouncements EA ON EAD.ExamsAnnouncementId = EA.ExamsAnnouncementId  
      INNER JOIN etrade.EServiceRequests E ON E.EserviceRequestId = ECI.EServiceRequestId  
      INNER JOIN etrade.EServiceRequestsDetails ED ON E.EserviceRequestId = ED.EserviceRequestId  
      INNER JOIN Types T ON t.TypeId = ed.RequestForUserType  
      LEFT JOIN Types_ara T_ara ON T.TypeId = T_ara.TypeId  
	  --left join etrade.MobileUserOrgMaps MUO on MUO.UserId =Ed.RequesterUserId
	 -- left join Organizations O on O.OrganizationId = MUO.OrganizationId
	  --LEFT JOIN BrokerOrgDetails BOD ON BOD.BrokerOrgId = O.OrganizationId  
	  --LEFT JOIN SubOrg SO ON SO.mainorgid = BOD.BrokerOrgId -- and SO.ChildOrgI
      WHERE e.RequesterUserId = @userid  
       AND eci.ExamResult = (  
        SELECT typeid  
        FROM Types  
        WHERE NAME = 'passed the exam'  
         AND StateId = 'EserviceExamResultsTypesCreatedState'  
        )  
			 	 AND ECI.StateId ='ExamCandidateInfoApprovedState' -- rama Kits-54372

       AND eci.DateModified >= dateadd(month, - 6, getdate())  
       AND e.EServiceRequestId NOT IN (  
        SELECT isnull(OrganizationId, 0)  
        FROM etrade.EServiceRequestsDetails  
        WHERE RequestServicesId = @serviceid  
         AND StateId IN (  
          'EServiceRequestDetailsProceedState'  
          ,'EServiceRequestIDPrintedState'  
          ,'EServiceRequestApprovedState'  
          ,'EServicesRequestDetailsSubmittedState'  
          ,'EServiceRequestDetailsReSubmittedState'  
          )  
        )  
       --('EServiceRequestDetailsProceedState','EServiceRequestDetailsCompletedState','EServicesRequestDetailsSubmittedState','EServiceRequestDetailsReSubmittedState'))      AND (@serviceid=28 OR @serviceid=31 )    
       AND examcandidateinfoid NOT IN (  
        SELECT isnull(requestforuserid, 0)  
        FROM etrade.eservicerequestsdetails  
        WHERE etrade.eservicerequestsdetails.RequestServicesId = @serviceid  
         AND StateId IN (  
          'EServiceRequestDetailsProceedState'  
          ,'EServicesRequestDetailsApprovedState'  
          ,'EServicesRequestDetailsSubmittedState'  
          ,'EServiceRequestDetailsReSubmittedState'  
          )  
        )  
       --('EServiceRequestDetailsProceedState','EServiceRequestDetailsCompletedState','EServicesRequestDetailsSubmittedState','EServiceRequestDetailsReSubmittedState'))       
       AND T.TypeId != 33224591 --exclude general broker for service 28,31    
       --SELECT * FROM types WHERE typeid IN (33224591,33224592,33224593,33237149)--broker types    
       AND ED.CIVILID NOT IN (  
        SELECT a.CIVILID  
        FROM ETRADE.ESERVICEREQUESTSDETAILS a  
        INNER JOIN ETRADE.ESERVICEREQUESTS b ON a.eservicerequestid = b.EServiceRequestId  
        WHERE a.requestERuserid = @userid  
         AND RequestServicesId = 17  
         AND a.STATEID NOT IN ('EServicesRequestDetailsDeletedState')  
         AND b.STATEID NOT IN ('EServiceRequestRejectedState')  
        )  
      --SELECT CIVILID FROM ETRADE.ESERVICEREQUESTSDETAILS WHERE requestERuserid= @userid  AND   
      --  RequestServicesId=17 AND  STATEID NOT IN ('EServicesRequestDetailsDeletedState')  
      -- start omar  
      
      UNION  
      
      SELECT DISTINCT o.StateId  
       ,NULL  
       ,NULL  
       ,O.OrganizationId 'OrgId'  
       ,O.OrganizationId 'OrganizationId'  
       ,'SubBrokerDetails' AS "TableName"  
       ,BOD.CivilId  
       ,CASE BBD.StateId  
        WHEN 'BrokBGDetailActivatedState'  
         THEN 'ACTIVE'  
        WHEN 'BrokBGDetailDeActivatedState'  
         THEN 'DEACTIVE'  
        ELSE 'INACTIVE'  
        END AS BGStatus  
      
	  --qasem2024
	   ,CASE  DR.StateId  
        WHEN 'DRPeopleCreatedState'  
         THEN 'ACTIVE'  
        WHEN 'DRPeopleDeActivatedState'  
         THEN 'DEACTIVE'  
        ELSE 'INACTIVE'  
        END AS AccountStatus  

     --  ,u.AccountStatus AS testaccnt  qasem2024
       ,BrokerType.TypeId  
 -- ,O.TradeLicenseNumber  
	         ,DR.BrokerLicenseNo as TradeLicenseNumber  --qasem7-12
			 ,  
       -- ISNULL(OA.Name,O.NAME) AS BrokerName,                
       DR.BrokerEngFirstName + ' ' + DR.BrokerEngLastName AS BrokerName  
       ,BLD.BrokerFileNumber  
       ,ISNULL(T.NAME, BrokerType.localdescription) AS BrokerType  
       ,BrokerType.NAME AS EseBrokerType  
       -- ISNULL(T.NAME, BrokerType.NAME) AS BrokerType,BrokerType.Name as EseBrokerType,            
       ,ISNULL(BBD.BGNo, '--') AS BankGuaranteeNo  
       ,BBD.BGExpiryDt AS BankGuaranteeExpiryDate  
       ,CONVERT(VARCHAR, BBD.BGExpiryDt, 103) AS 'BankGuaranteeExpiryDatee' -- Abdul Karim            
       --,*                
       ,CONVERT(VARCHAR, DR.BrokerExpiryDate, 103) AS LicenseNumberExpiryDate --7-12 qasem 
       ,DR.PersonalId  
      FROM Organizations O -- Parent Organizations and File Number      
      LEFT JOIN users U ON u.OrganizationId = o.OrganizationId  
      LEFT JOIN Organizations_ara OA ON OA.OrganizationId = O.OrganizationId  
      LEFT JOIN DRPeople DR ON DR.PersonalId = U.PersonalId  
      INNER JOIN BrokerOrgDetails BOD ON DR.DROrganizationId = BOD.BrokerOrgId  
      INNER JOIN organizations sb ON BOD.BrokerOrgId = sb.OrganizationId  
      LEFT JOIN BrokBGDetails BBD ON BBD.BrokerOrgId = DR.DRPeopleId  
	  -- AND BBD.StateId NOT IN ('BrokBGDetailDeActivatedState')  qasem2024
		AND BBD.StateId IN ('BrokBGDetailActivatedState','BrokBGDetailExpiredState')   --qasem2024
      INNER JOIN BrokLicenseDetails BLD ON BLD.BrokerOrgId = O.OrganizationId  
      INNER JOIN Types BrokerType ON BrokerType.TypeId = bod.BrokerTypeId  
      LEFT JOIN Types_ara T ON BrokerType.TypeId = T.TypeId  
      --where o.OrganizationId in (SELECT outputid FROM #TEMP)            
      WHERE DR.DRBrokerType = [dbo].[KWConstantfn]('GBL_Types.TYPE.DRBroker')  
       AND DR.DROrganizationId IN (  
        SELECT *  
        FROM etrade.[fnSplitbigint](@OrganizationIDS)  
        )  
       AND DR.StateId IN (  
        SELECT list  
        FROM @stateid  
        )  
       --qasem  
       AND DR.PersonalId NOT IN (  
        SELECT OrganizationId  
        FROM etrade.EServiceRequestsDetails  
        WHERE StateId IN (  
          'EServiceRequestDetailsProceedState'  
          ,'EServicesRequestDetailsSubmittedState'  
          ,'EServicesRequestDetailsCreatedState'  
          ,'EServiceRequestDetailsReSubmittedState'  
          )  
         AND RequestServicesId = @serviceid  
         AND RequesterUserId = @Userid  
        )  
       --where O.OrganizationId in (@OrganizationIDS)  
       -- end omar  
     END --11.8  
    END --11.4  
  
    --  exec etrade.usp_MApp_GetAssociatedOrganizations 150      
    -- Limited for brokers which have license    
    --- Change Job Title- With Broker License- General Authority for Manpower    
    --- Change Job Title and Renew Residency- General Authority for Manpower    
    --Limited for brokers which don't have license yet, but passed the broker exam    
    --- Change Job Title- General Authority for Manpower    
    --- Change Job Title and Transfer Residency- General Authority for Manpower    
    PRINT ('camesecond')  
      
    --select * from @stateid;   
  
    /*  
     Service Subscription,  
     Request For Renewing  Broker License,  
     Organization Registration Service,  
     UserRegistrationRequest,  
     Clearing Agent Exam Request,  
     E Payment Service,  
     HS Code Search,  
     Deactivate Broker License Request,  
     Broker License Cancellation Request,  
     Broker Transfer Request,  
     To Whom It Concern Letter Request,  
     Print Lost Broker License  Card Request,  
     Broker License Issuance Request,  
     Self Payment Services,  
     Organization Name Change,  
     Add New Importer License,  
     Renew Importer License,  
     Renew Industrial License,  
     Renew Commercial License,  
     New Authorized Signatory,  
     Renew Authorized Signatory,  
     Remove Authorized Signatory,  
     Change Commercial Address,  
     User Account Cancellation,  
     DeActivate Account,  
     User Account Update,  
     */    
   
             
    IF (@serviceid NOT IN (20,21,22,23,24,25,26,27,28,29,30,31,32,33))  
    BEGIN --11.9  
     PRINT ('renewal')  

  
     SELECT DISTINCT --ERS.stateid as 'OpStateid',            
      sb.OrganizationId AS 'OrganizationId'  
      ,sb.NAME AS BrokerName  
      ,bld.LicenseNo AS TradeLicenseNumber  
      ,'SubBrokerDetails' AS "TableName"  
      ,  
      --  ISNULL(T.NAME, BrokerType.NAME) AS BrokerType,BrokerType.Name as EseBrokerType         
      ISNULL(T.NAME, BrokerType.localdescription) AS BrokerType  
      ,BrokerType.NAME AS EseBrokerType  
      ,CASE BBD.StateId  
       WHEN 'BrokBGDetailActivatedState'  
        THEN 'ACTIVE'  
       WHEN 'BrokBGDetailDeActivatedState'  
        THEN 'DEACTIVE'  
      -- ELSE BBD.StateId  --qasem2024
	   ELSE 'INACTIVE' --qasem2024
      -- END AS AccountStatus --qasem2024 
       END AS BGStatus --qasem2024  

	   --qasem2024 
	   ,sb.StateId  
	   ,CASE sb.StateId  
        WHEN 'OrganizationsCreatedState'  
         THEN 'ACTIVE'  
        WHEN 'OrganizationsModifyState'  
         THEN 'ACTIVE'  
        WHEN 'OrganizationsNotActivatedState'  
         THEN 'DEACTIVE'  
        WHEN 'OrganizationsTransferredState'  
         THEN 'TRANSFERRED'  
        ELSE 'INACTIVE'  
        END AS AccountStatus  


      ,BrokerType.TypeId  
      ,ISNULL(BBD.BGNo, '--') AS BankGuaranteeNo  
      ,BBD.BGExpiryDt AS BankGuaranteeExpiryDate  
      ,CONVERT(VARCHAR, BBD.BGExpiryDt, 103) AS 'BankGuaranteeExpiryDatee'  
      ,'' AS PersonalId --qasem2  
     FROM Organizations O -- Parent Organizations and File Number      
     INNER JOIN SubOrg SO ON O.OrganizationId = SO.MainOrgId  
      AND SO.ChildOrgId IN (  
       SELECT *  
       FROM #TEMP  
       )  
     INNER JOIN BrokerOrgDetails BOD ON SO.ChildOrgId = BOD.BrokerOrgId -- Special Broker      
     INNER JOIN organizations sb ON BOD.BrokerOrgId = sb.OrganizationId  
     LEFT JOIN BrokBGDetails BBD ON BBD.BrokerOrgId = bod.BrokerOrgId  
    --  AND BBD.StateId NOT IN ('BrokBGDetailDeActivatedState')  qasem2024
	  AND BBD.StateId IN ('BrokBGDetailActivatedState','BrokBGDetailExpiredState')   --qasem2024
     INNER JOIN BrokLicenseDetails BLD ON BLD.BrokerOrgId = SO.ChildOrgId -- Special Broker License Details and File Number      
     INNER JOIN BrokerImporter BI ON BI.BrokerOrgId = SO.ChildOrgId  
     INNER JOIN Types BrokerType ON BrokerType.TypeId = bod.BrokerTypeId  
     LEFT JOIN Types_ara T ON BrokerType.TypeId = T.TypeId  
     /*WHERE o.OrganizationId IN (  
       SELECT outputid  
       FROM #TEMP  
       ) AND --omar --mohan    */
      WHERE o.StateId IN (  
       SELECT list  
       FROM @stateid  
       )  
      AND isnull(SO.ChildOrgId, 0) NOT IN (  
       SELECT OrganizationId  
       FROM etrade.EServiceRequestsDetails  
       WHERE StateId IN (  
         'EServiceRequestDetailsProceedState'  
         ,'EServicesRequestDetailsSubmittedState'  
         ,'EServicesRequestDetailsCreatedState'  
         ,'EServiceRequestDetailsReSubmittedState'  
         )  
        AND RequestServicesId = @serviceid  
        AND RequesterUserId = @Userid  
       )  
      AND o.stateid <> ('OrganizationsTransferredState')  
     
     UNION  
     
     SELECT -- '' as 'OpStateid'   ,                        
      DRP.PersonalId AS OrganizationId  
      ,(ISNULL(P.FirstName, '') + ' ' + ISNULL(P.SecondName, '') + ' ' + ISNULL(P.ThirdName, '') + ' ' + ISNULL(P.LastName, '')) AS BrokerName  
      ,--qasem2  
      --       ''   BrokerName,            
      --DRP.DROrganizationId AS OrganizationId,                            
      DRP.BrokerLicenseNo AS TradeLicenseNumber  
      ,'SubBrokerDetails' AS "TableName"  
      ,  
      --   ISNULL(T.NAME, BrokerType.NAME) AS BrokerType,BrokerType.Name as EseBrokerType,                
      ISNULL(T.NAME, BrokerType.localdescription) AS BrokerType  
      ,BrokerType.NAME AS EseBrokerType  
      ,CASE BBG.StateId  
       WHEN 'BrokBGDetailActivatedState'  
        THEN 'ACTIVE'  
       WHEN 'BrokBGDetailDeActivatedState'  
        THEN 'DEACTIVE'  
       ELSE 'INACTIVE'  
	-- END AS AccountStatus --qasem2024 
       END AS BGStatus --qasem2024     
	        
			,  DRP.StateId  
	  --qasem2024 
	   ,CASE  DRP.StateId  
        WHEN 'DRPeopleCreatedState'  
         THEN 'ACTIVE'  
        WHEN 'DRPeopleDeActivatedState'  
         THEN 'DEACTIVE'  
        ELSE 'INACTIVE'  
        END AS AccountStatus  

	 ,BrokerType.TypeId  ,

      -- DRP.BrokerCode,                           
      --CASE U.AccountStatus WHEN 'y' THEN U.AccountStatus ELSE '0' END AS AccountStatus,                     
      --  DP.StateName AS AccountStatus,                     
      --  P.PersonalId,                        
      BBG.BGNo AS BankGuaranteeNo  
      ,BBG.BGExpiryDt AS BankGuaranteeExpiryDate  
      ,--qasem  
      CONVERT(VARCHAR, BBG.BGExpiryDt, 103) AS 'BankGuaranteeExpiryDatee' -- Abdul Karim    qasem  
      ,P.PersonalId --qasem2  
     FROM People P  
     INNER JOIN DRPeople DRP ON DRP.PersonalId = P.PersonalId  
     OUTER APPLY (  
      SELECT TOP 1 *  
      FROM BrokBGDetails BBG  
      WHERE BBG.BrokerOrgId = DRP.DRPeopleId  
      ORDER BY BBG.BrokBGDetailId DESC  
      ) BBG  
     LEFT JOIN Users U ON U.PersonalId = DRP.PersonalId  
     LEFT JOIN DataProfileClassWFStates DP ON DRP.StateId = DP.StateId  
     LEFT JOIN Types BrokerType ON DRP.DRBrokerType = BrokerType.TypeId  
     LEFT JOIN Types_ara T ON BrokerType.TypeId = T.TypeId  
     WHERE DRP.DRBrokerType = [dbo].[KWConstantfn]('GBL_Types.TYPE.DRBroker')  
      AND DRP.DROrganizationId IN (  
       SELECT *  
       FROM etrade.[fnSplitbigint](@OrganizationIDS)  
       )  
      AND DRP.StateId IN (  
       SELECT list  
       FROM @stateid  
       )  
      --qasem  
      AND DRP.PersonalId NOT IN (  --qasem5 remove @OrganizationIDS
       SELECT OrganizationId  
       FROM etrade.EServiceRequestsDetails  
       WHERE StateId IN (  
         'EServiceRequestDetailsProceedState'  
         ,'EServicesRequestDetailsSubmittedState'  
         ,'EServicesRequestDetailsCreatedState'  
         ,'EServiceRequestDetailsReSubmittedState'  
         )  
        AND RequestServicesId = @serviceid  
        AND RequesterUserId = @Userid  
       )  
     ORDER BY BrokerType.TypeId  
    END --11.9  
      -- where o.OrganizationId in (4203)            
      --SELECT outputid FROM #TEMP;            
      --DROP TABLE #TEMP;            
   END --11.3  
  END --11.2  

  
  
        DROP TABLE IF EXISTS #TEMP;  
    END --11   
 -- all clearingagent          
  else            
  BEGIN --12  
  print('else');  
  -- select * from etrade.Eservices      
  IF (@serviceid IN (14)) --Broker Transfer Request  
  BEGIN --12.1  
   SELECT DISTINCT o.StateId  
    ,SO.ChildOrgId  
    --,isnull(u.UserId,'') as userid            
    ,SO.MainOrgId  
    ,isnull(so.ChildOrgId, O.OrganizationId) 'OrgId'  
    ,isnull(so.ChildOrgId, O.OrganizationId) 'OrganizationId'  
    ,'SubBrokerDetails' AS "TableName"  
    ,BOD.CivilId  
    ,CASE BBD.StateId  
     WHEN 'BrokBGDetailActivatedState'  
      THEN 'ACTIVE'  
     WHEN 'BrokBGDetailDeActivatedState'  
      THEN 'DEACTIVE'  
     ELSE 'INACTIVE'  
     END AS BGStatus  
    ,  
    --CASE u.AccountStatus            
    --WHEN 'y' THEN 'ACTIVE'             
    --WHEN 'NULL' THEN 'ACTIVE'              
    --WHEN 23219 THEN 'WECS 9500'             
    --ELSE BBD.StateId             
    CASE O.StateId  
     WHEN 'OrganizationsCreatedState'  
      THEN 'ACTIVE'  
     WHEN 'OrganizationsModifyState'  
      THEN 'ACTIVE'  
     WHEN 'OrganizationsNotActivatedState'  
      THEN 'DEACTIVE'  
     WHEN 'OrganizationsTransferredState'  
      THEN 'TRANSFERRED'  
     ELSE 'INACTIVE'  
     END AS AccountStatus  
    ,u.AccountStatus AS testaccnt  
    ,O.TradeLicenseNumber  
    ,ISNULL(OA.NAME, O.NAME) AS BrokerName  
    ,BLD.BrokerFileNumber  
    ,  
    --  ISNULL(T.NAME, BrokerType.NAME) AS BrokerType,BrokerType.Name as EseBrokerType            
    ISNULL(T.NAME, BrokerType.localdescription) AS BrokerType  
    ,BrokerType.NAME AS EseBrokerType  
    ,ISNULL(BBD.BGNo, '--') AS BankGuaranteeNo  
    ,BBD.BGExpiryDt AS BankGuaranteeExpiryDate  
    ,CONVERT(VARCHAR, BBD.BGExpiryDt, 103) AS 'BankGuaranteeExpiryDatee'  
   -- Abdul Karim            
   -- ,*            
   FROM Organizations O  
   LEFT JOIN BrokerOrgDetails BOD ON BOD.BrokerOrgId = O.OrganizationId  
   LEFT JOIN BrokBGDetails BBD ON BBD.BrokerOrgId = BOD.BrokerOrgId  
    AND BBD.StateId NOT IN ('BrokBGDetailDeActivatedState')  
   LEFT JOIN SubOrg SO ON SO.ChildOrgId = BOD.BrokerOrgId  
   LEFT JOIN Types BrokerType ON BOD.BrokerTypeId = BrokerType.TypeId  
   LEFT JOIN Types_ara T ON BrokerType.TypeId = T.TypeId  
   LEFT JOIN BrokLicenseDetails BLD ON O.OrganizationId = BLD.BrokerOrgId  
   LEFT JOIN DataProfileClassWorkflowStates W ON BOD.StateId = W.StateId  
   LEFT JOIN DataProfileClassWorkflowStates_ara WA ON W.StateId = WA.StateId  
   LEFT JOIN Organizations_ara OA ON OA.OrganizationId = O.OrganizationId  
   LEFT JOIN users U ON u.OrganizationId = o.OrganizationId  
   -- left join etrade.EServiceRequestsDetails ERS on ers.OrganizationId=O.OrganizationId             
   --   left join etrade.EServiceRequests ES on ES.EserviceRequestId =ERS.EserviceRequestId                
   WHERE SO.MainOrgId IN (  
     SELECT *  
     FROM etrade.[fnSplitbigint](@OrganizationIDS)  
     ) --( @OrganizationIDS)--.REPLACE('''',''))            
    AND (  
     (  
      ISNULL(@civilid, '') <> ''  
      AND BOD.CivilId = @civilid  
      )  
     OR (  
      ISNULL(@civilid, '') = ''  
      AND 1 = 1  
      )  
     )  
    AND (  
     (  
      ISNULL(@Tradelicenseno, '') <> ''  
      AND O.TradeLicenseNumber = @Tradelicenseno  
      )  
     OR (  
      ISNULL(@Tradelicenseno, '') = ''  
      AND 1 = 1  
      )  
     )  
    AND (  
     (  
      ISNULL(@BrokerType, '') <> ''  
      AND BrokerType.NAME = @BrokerType  
      )  
     OR (  
      ISNULL(@BrokerType, '') = ''  
      AND 1 = 1  
      )  
     )  
    -- and (ers.StateId not  in ('EServiceRequestDetailsSubmittedState','EServiceRequestDetailsCompletedState') or ers.StateId is null)            
    --and o.StateId in ('OrganizationsModifyState','OrganizationsCreatedState','OrganizationsNotActivatedState')            
    AND o.StateId IN (  
     SELECT list  
     FROM @stateid  
     )  
    AND isnull(SO.ChildOrgId, 0) NOT IN (  
     SELECT OrganizationId  
     FROM etrade.EServiceRequestsDetails  
     WHERE StateId IN (  
       'EServicesRequestDetailsSubmittedState'  
       ,'EServicesRequestDetailsCreatedState'  
       ,'EServiceRequestDetailsReSubmittedState'  
       )  
      AND RequestServicesId = @serviceid  
      AND RequesterUserId = @Userid  
     )  
    --and o.StateId in (@stateid)            
  END --12.1  
  
  -- else     
  /*  
    To Whom It Concern Letter Request,  
    Print Lost Broker License  Card Request,  
    Broker License Cancellation Request,  
    Deactivate Broker License Request,  
    Request For Renewing  Broker License  
   */         
   IF (@serviceid IN (15,16,12,2,13))  
   BEGIN --12.2  
    PRINT ('reached')  
  
    SELECT DISTINCT o.StateId  
     ,SO.ChildOrgId  
     ,SO.MainOrgId  
     ,isnull(so.ChildOrgId, O.OrganizationId) 'OrgId'  
     ,isnull(so.ChildOrgId, O.OrganizationId) 'OrganizationId'  
     ,'SubBrokerDetails' AS "TableName"  
     ,  
     -- , BBD.StateId as BGStatus,               
     BOD.CivilId  
     ,CASE BBD.StateId  
      WHEN 'BrokBGDetailActivatedState'  
       THEN 'ACTIVE'  
      WHEN 'BrokBGDetailDeActivatedState'  
       THEN 'DEACTIVE'  
      ELSE 'INACTIVE'  
      END AS BGStatus  
     ,  
     --   CASE BBD.StateId             
     --  WHEN 'BrokBGDetailActivatedState' THEN 'ACTIVE'             
     --  WHEN 'BrokBGDetailDeActivatedState' THEN 'DEACTIVE'              
     --  ELSE             
     --  'INACTIVE'            
     --END as AccountStatus  
	 o.StateId  ,
     CASE o.StateId  
      WHEN 'OrganizationsCreatedState'  
       THEN 'ACTIVE'  
      WHEN 'OrganizationsModifyState'  
       THEN 'ACTIVE'  
      WHEN 'OrganizationsNotActivatedState'  
       THEN 'DEACTIVE'  
      WHEN 'OrganizationsTransferredState'  
       THEN 'TRANSFERRED'  
      ELSE 'INACTIVE'  
      END AS AccountStatus  
   --  ,u.AccountStatus AS testaccnt  qasem2024
     ,BrokerType.TypeId  
     ,O.TradeLicenseNumber  
     ,ISNULL(OA.NAME, O.NAME) AS BrokerName  
     ,BLD.BrokerFileNumber  
     ,  
     -- ISNULL(T.NAME, BrokerType.NAME) AS BrokerType,BrokerType.Name as EseBrokerType,            
     ISNULL(T.NAME, BrokerType.localdescription) AS BrokerType  
     ,BrokerType.NAME AS EseBrokerType  
     ,ISNULL(BBD.BGNo, '--') AS BankGuaranteeNo  
     ,BBD.BGExpiryDt AS BankGuaranteeExpiryDate  
     ,CONVERT(VARCHAR, BBD.BGExpiryDt, 103) AS 'BankGuaranteeExpiryDatee' -- Abdul Karim           
     ,CONVERT(VARCHAR, BLD.DtOfExpiry, 103) AS LicenseNumberExpiryDate  
     --,'' AS PersonalId --qasem2  
    --,*                
    FROM Organizations O  
    LEFT JOIN BrokerOrgDetails BOD ON BOD.BrokerOrgId = O.OrganizationId  
    LEFT JOIN BrokBGDetails BBD ON BBD.BrokerOrgId = BOD.BrokerOrgId  
	 -- AND BBD.StateId NOT IN ('BrokBGDetailDeActivatedState')  
	AND BBD.StateId IN ('BrokBGDetailActivatedState','BrokBGDetailExpiredState')   --qasem2024
    LEFT JOIN SubOrg SO ON SO.ChildOrgId = BOD.BrokerOrgId  
    LEFT JOIN Types BrokerType ON BOD.BrokerTypeId = BrokerType.TypeId  
    LEFT JOIN Types_ara T ON BrokerType.TypeId = T.TypeId  
    LEFT JOIN BrokLicenseDetails BLD ON O.OrganizationId = BLD.BrokerOrgId  
    LEFT JOIN DataProfileClassWorkflowStates W ON BOD.StateId = W.StateId  
    LEFT JOIN DataProfileClassWorkflowStates_ara WA ON W.StateId = WA.StateId  
    LEFT JOIN Organizations_ara OA ON OA.OrganizationId = O.OrganizationId  
    LEFT JOIN users U ON u.OrganizationId = o.OrganizationId  
    --left join etrade.EServiceRequestsDetails ERS on ers.OrganizationId=O.OrganizationId               
    WHERE  
     --U.UserId=@Userid               
     O.OrganizationId IN (  
      SELECT *  
      FROM etrade.[fnSplitbigint](@OrganizationIDS)  
      ) --( @OrganizationIDS)--.REPLACE('''',''))            
     AND (  
      (  
       ISNULL(@civilid, '') <> ''  
       AND BOD.CivilId = @civilid  
       )  
      OR (  
       ISNULL(@civilid, '') = ''  
       AND 1 = 1  
       )  
      )  
     AND (  
      (  
       ISNULL(@Tradelicenseno, '') <> ''  
       AND O.TradeLicenseNumber = @Tradelicenseno  
       )  
      OR (  
       ISNULL(@Tradelicenseno, '') = ''  
       AND 1 = 1  
       )  
      )  
     AND (  
      (  
       ISNULL(@BrokerType, '') <> ''  
       AND BrokerType.NAME = @BrokerType  
       )  
      OR (  
       ISNULL(@BrokerType, '') = ''  
       AND 1 = 1  
       )  
      )  
     --and (ers.StateId  in ('EServicesRequestDetailsCreatedState','EServiceRequestDetailsCompletedState') or ers.StateId is null)            
     -- and (ers.StateId not  in ('EServiceRequestDetailsSubmittedState') or ers.StateId is null)            
     -- and (ers.StateId not  in ('EServiceRequestDetailsSubmittedState','EServiceRequestDetailsCompletedState') or ers.StateId is null)            
     AND o.StateId IN (  
      SELECT list  
      FROM @stateid  
      )  
     AND isnull(so.ChildOrgId, o.OrganizationId) NOT IN (  
      SELECT OrganizationId  
      FROM etrade.EServiceRequestsDetails  
      WHERE StateId IN (  
        'EServicesRequestDetailsSubmittedState'  
        ,'EServicesRequestDetailsCreatedState'  
        ,'EServiceRequestDetailsReSubmittedState'  
        ,'EServiceRequestDetailsProceedState'  
        )  
       AND RequestServicesId = @serviceid  
       AND RequesterUserId = @Userid  
      )  
    -- and ers.StateId not in ('EServiceRequestDetailsSubmittedState')            
   
    UNION  
   
    --all            
    SELECT DISTINCT o.StateId  
     ,SO.ChildOrgId  
     --,isnull(u.UserId,'') as userid            
     ,SO.MainOrgId  
     ,isnull(so.ChildOrgId, O.OrganizationId) 'OrgId'  
     ,isnull(so.ChildOrgId, O.OrganizationId) 'OrganizationId'  
     ,'SubBrokerDetails' AS "TableName"  
     ,BOD.CivilId  
     ,CASE BBD.StateId  
      WHEN 'BrokBGDetailActivatedState'  
       THEN 'ACTIVE'  
      WHEN 'BrokBGDetailDeActivatedState'  
       THEN 'DEACTIVE'  
      ELSE 'INACTIVE'  
      END AS BGStatus  
     ,  
     --CASE u.AccountStatus            
     --WHEN 'y' THEN 'ACTIVE'             
     --WHEN 'NULL' THEN 'ACTIVE'              
     --WHEN 23219 THEN 'WECS 9500'             
     --ELSE BBD.StateId             
     -- CASE BBD.StateId             
     --  WHEN 'BrokBGDetailActivatedState' THEN 'ACTIVE'             
     --  WHEN 'BrokBGDetailDeActivatedState' THEN 'DEACTIVE'              
     --  ELSE             
     --  'INACTIVE'            
     --END as AccountStatus     
	 o.StateId  ,
     CASE O.StateId  
      WHEN 'OrganizationsCreatedState'  
       THEN 'ACTIVE'  
      WHEN 'OrganizationsNotActivatedState'  
       THEN 'DEACTIVE'  
      WHEN 'OrganizationsTransferredState'  
       THEN 'TRANSFERRED'  
      WHEN 'OrganizationsModifyState'  
       THEN 'ACTIVE'  
      ELSE 'INACTIVE'  
      END AS AccountStatus  
   --  ,u.AccountStatus AS testaccnt  qasem2024
     ,BrokerType.TypeId  
     ,O.TradeLicenseNumber  
     ,ISNULL(OA.NAME, O.NAME) AS BrokerName  
     ,BLD.BrokerFileNumber  
     ,  
     -- ISNULL(T.NAME, BrokerType.NAME) AS BrokerType,BrokerType.Name as EseBrokerType            
     ISNULL(T.NAME, BrokerType.localdescription) AS BrokerType  
     ,BrokerType.NAME AS EseBrokerType  
     ,ISNULL(BBD.BGNo, '--') AS BankGuaranteeNo  
     ,BBD.BGExpiryDt AS BankGuaranteeExpiryDate  
     ,CONVERT(VARCHAR, BBD.BGExpiryDt, 103) AS 'BankGuaranteeExpiryDatee' -- Abdul Karim       
     ,CONVERT(VARCHAR, BLD.DtOfExpiry, 103) AS LicenseNumberExpiryDate  
     --,DR.PersonalId --qasem2  
     -- ,*            
    FROM Organizations O  
    LEFT JOIN BrokerOrgDetails BOD ON BOD.BrokerOrgId = O.OrganizationId  
    LEFT JOIN BrokBGDetails BBD ON BBD.BrokerOrgId = BOD.BrokerOrgId  
	 -- AND BBD.StateId NOT IN ('BrokBGDetailDeActivatedState')  
	AND BBD.StateId IN ('BrokBGDetailActivatedState','BrokBGDetailExpiredState')   --qasem2024
    LEFT JOIN SubOrg SO ON SO.ChildOrgId = BOD.BrokerOrgId  
    LEFT JOIN Types BrokerType ON BOD.BrokerTypeId = BrokerType.TypeId  
    LEFT JOIN Types_ara T ON BrokerType.TypeId = T.TypeId  
    LEFT JOIN BrokLicenseDetails BLD ON O.OrganizationId = BLD.BrokerOrgId  
    LEFT JOIN DataProfileClassWorkflowStates W ON BOD.StateId = W.StateId  
    LEFT JOIN DataProfileClassWorkflowStates_ara WA ON W.StateId = WA.StateId  
    LEFT JOIN Organizations_ara OA ON OA.OrganizationId = O.OrganizationId  
    LEFT JOIN users U ON u.OrganizationId = o.OrganizationId  
    --LEFT JOIN DRPeople DR ON DR.PersonalId = U.PersonalId --qasem2  
     -- left join etrade.EServiceRequestsDetails ERS on ers.OrganizationId=O.OrganizationId             
    --   left join etrade.EServiceRequests ES on ES.EserviceRequestId =ERS.EserviceRequestId                
    WHERE SO.MainOrgId IN (  
      SELECT *  
      FROM etrade.[fnSplitbigint](@OrganizationIDS)  
      ) --( @OrganizationIDS)--.REPLACE('''',''))            
     AND (  
      (  
       ISNULL(@civilid, '') <> ''  
       AND BOD.CivilId = @civilid  
       )  
      OR (  
       ISNULL(@civilid, '') = ''  
       AND 1 = 1  
       )  
      )  
     AND (  
      (  
       ISNULL(@Tradelicenseno, '') <> ''  
       AND O.TradeLicenseNumber = @Tradelicenseno  
       )  
      OR (  
       ISNULL(@Tradelicenseno, '') = ''  
       AND 1 = 1  
       )  
      )  
     AND (  
      (  
       ISNULL(@BrokerType, '') <> ''  
       AND BrokerType.NAME = @BrokerType  
       )  
      OR (  
       ISNULL(@BrokerType, '') = ''  
       AND 1 = 1  
       )  
      )  
     -- and (ers.StateId not  in ('EServiceRequestDetailsSubmittedState','EServiceRequestDetailsCompletedState') or ers.StateId is null)            
     --and o.StateId in ('OrganizationsModifyState','OrganizationsCreatedState','OrganizationsNotActivatedState')            
     AND o.StateId IN (  
      SELECT list  
      FROM @stateid  
      )  
     --AND DR.PersonalId NOT IN --qasem2     
     AND isnull(so.ChildOrgId, o.OrganizationId) NOT IN (  
     (  
      SELECT OrganizationId  
      FROM etrade.EServiceRequestsDetails  
      WHERE StateId IN (  
        'EServicesRequestDetailsSubmittedState'  
        ,'EServicesRequestDetailsCreatedState'  
        ,'EServiceRequestDetailsReSubmittedState'  
        ,'EServiceRequestDetailsProceedState'  
        )  
       AND RequestServicesId = @serviceid  
       AND RequesterUserId = @Userid  
      ))  
    --and o.StateId in (@stateid)            
    ORDER BY BrokerType.TypeId;  
   END --12.2  
  
   IF (@serviceid IN (17)) --Broker License Issuance Request  
   BEGIN --12.3  
    PRINT ('here')  
    PRINT 'service id 17 progress 2'  
  
    SELECT e.RequesterUserId  
     ,T.NAME AS EseBrokerType  
     ,ISNULL(T_ara.NAME, T.NAME) AS BrokerType  
     ,'SubBrokerDetails' AS "TableName"  
     ,ED.RequestForName AS BrokerName  
     ,E.EserviceRequestId AS OrganizationId  
     ,  
     --E.EserviceRequestNumber as encryptedEServiceRequestNumber,            
     E.EserviceRequestNumber AS TradeLicenseNumber  
     ,e.EserviceRequestId  
     ,E.EserviceRequestNumber  
     ,ed.RequestForUserType  
     ,EAD.ClearanceExamType  
     ,eci.ExamResult  
     ,eci.DateModified  
     ,dateadd(month, - 6, getdate())  
     ,*  
    FROM ExamCandidateInfo ECI  
    INNER JOIN ExamsAnnouncementDetails EAD ON ECI.ExamsAnnouncementDetailsId = EAD.ExamsAnnouncementDetailsId  
    INNER JOIN ExamsAnnouncements EA ON EAD.ExamsAnnouncementId = EA.ExamsAnnouncementId  
    INNER JOIN etrade.EServiceRequests E ON E.EserviceRequestId = ECI.EServiceRequestId  
    INNER JOIN etrade.EServiceRequestsDetails ED ON E.EserviceRequestId = ED.EserviceRequestId  
    INNER JOIN Types T ON t.TypeId = ed.RequestForUserType  
    LEFT JOIN Types_ara T_ara ON T.TypeId = T_ara.TypeId  
    WHERE e.RequesterUserId = @Userid  
     AND eci.ExamResult = (  
      SELECT typeid  
      FROM Types  
      WHERE NAME = 'passed the exam'  
       AND StateId = 'EserviceExamResultsTypesCreatedState'  
      )  
	  	 	 AND ECI.StateId ='ExamCandidateInfoApprovedState' -- rama Kits-54372

     AND eci.DateModified >= dateadd(month, - 24, getdate())  
     /* AND eci.DateModified >= (case when ED.RequestForUserType=33224591 then dateadd(month, - 36, getdate())    
     else dateadd(month, - 12, getdate()) end) */  
     AND e.EServiceRequestId NOT IN (  
      SELECT isnull(OrganizationId, 0)  
      FROM etrade.EServiceRequestsDetails  
      WHERE RequestServicesId = 17  
       AND StateId IN (  
        'EServiceRequestDetailsCompletedState'  
        ,'EServicesRequestDetailsSubmittedState'  
        ,'EServiceRequestDetailsReSubmittedState'  
        ,'EServiceRequestDetailsProceedState'  
        )  
      )  
     --  and ead.ClearanceExamType=(select typeid from Types where Name='General Broker' and StateId='BrokerTypesModifiedState')            
     AND ED.CIVILID NOT IN (  
      SELECT CIVILID  
      FROM ETRADE.ESERVICEREQUESTSDETAILS  
      WHERE requestERuserid = @userid  
       AND RequestServicesId = 17  
       AND STATEID NOT IN (  
        'EServicesRequestDetailsDeletedState'  
        ,'EServiceRequestDetailsFinalRejectedState'  
        ) --rama final rejected  
      )  
   END --12.3  
  
   /*  
    Cancel Commercial License -Ministry of Commerce and Industry,  
    Issue Commercial License- Ministry of Commerce and Industry,  
    Change Commercial License Address Letter - Ministry of Commerce and Industry,  
    Change Commercial License Business - Ministry of Commerce and Industry,  
    Release Bank Guarantee - Revenue Control,  
    Good conduct and behavior- General Directorate of Criminal Evidence,  
    Renew Commercial License - Ministry of Commerce and Industry,  
    Change Job Title and Renew Residency- General Authority for Manpower,  
    Change Job Title and Transfer Residency- General Authority for Manpower,  
    Residency Renew- General Authority for Manpower,  
    Residency Transfer- General Authority for Manpower,  
    Change Job Title- General Authority for Manpower,  
    Change Job Title- With Broker License- General Authority for Manpower,  
    Deactivate Commercial License- Death- Ministry of Commerce and Industry  
   */  
  
   IF (@serviceid IN (20,21,22,23,24,25,26,27,28,29,30,31,32,33))  
   BEGIN --12.4  
    /*  
     Cancel Commercial License -Ministry of Commerce and Industry,  
     Issue Commercial License- Ministry of Commerce and Industry,  
     Change Commercial License Address Letter - Ministry of Commerce and Industry,  
     Change Commercial License Business - Ministry of Commerce and Industry,  
     Renew Commercial License - Ministry of Commerce and Industry,  
     Deactivate Commercial License- Death- Ministry of Commerce and Industry  
    */  	
    IF (@serviceid IN (20,21,22,23,26,33)) -- General Broker Only 
    BEGIN  
     (  
       SELECT DISTINCT o.StateId  
        ,SO.ChildOrgId  
        ,SO.MainOrgId  
        ,isnull(so.ChildOrgId, O.OrganizationId) 'OrgId'  
        ,isnull(so.ChildOrgId, O.OrganizationId) 'OrganizationId'  
        ,'SubBrokerDetails' AS "TableName"  
        ,BOD.CivilId  
        ,CASE BBD.StateId  
         WHEN 'BrokBGDetailActivatedState'  
          THEN 'ACTIVE'  
         WHEN 'BrokBGDetailDeActivatedState'  
          THEN 'DEACTIVE'  
         ELSE 'INACTIVE'  
         END AS BGStatus  
		 ,O.StateId  --qasem2024
        ,CASE O.StateId  
         WHEN 'OrganizationsCreatedState'  
          THEN 'ACTIVE'  
         WHEN 'OrganizationsModifyState'  
          THEN 'ACTIVE'  
         WHEN 'OrganizationsNotActivatedState'  
          THEN 'DEACTIVE'  
         WHEN 'OrganizationsTransferredState'  
          THEN 'TRANSFERRED'  
         ELSE 'INACTIVE'  
         END AS AccountStatus  
       -- ,u.AccountStatus AS testaccnt  qasem2024
        ,BrokerType.TypeId  
        ,O.TradeLicenseNumber  
        ,ISNULL(OA.NAME, O.localdescription) AS BrokerName  
        ,BLD.BrokerFileNumber  
        ,  
        -- ISNULL(T.NAME, BrokerType.NAME) AS BrokerType,BrokerType.Name as EseBrokerType,            
        ISNULL(T.NAME, BrokerType.localdescription) AS BrokerType  
        ,BrokerType.NAME AS EseBrokerType  
        ,ISNULL(BBD.BGNo, '--') AS BankGuaranteeNo  
        ,BBD.BGExpiryDt AS BankGuaranteeExpiryDate  
        ,CONVERT(VARCHAR, BBD.BGExpiryDt, 103) AS 'BankGuaranteeExpiryDatee' -- Abdul Karim            
        --,*         
        ,CONVERT(VARCHAR, BLD.DtOfExpiry, 103) AS LicenseNumberExpiryDate  
       FROM Organizations O  
       LEFT JOIN BrokerOrgDetails BOD ON BOD.BrokerOrgId = O.OrganizationId  
       LEFT JOIN BrokBGDetails BBD ON BBD.BrokerOrgId = BOD.BrokerOrgId  
       -- AND BBD.StateId NOT IN ('BrokBGDetailDeActivatedState')  
		AND BBD.StateId IN ('BrokBGDetailActivatedState','BrokBGDetailExpiredState')   --qasem2024
       LEFT JOIN SubOrg SO ON SO.ChildOrgId = BOD.BrokerOrgId -- and SO.ChildOrgId  in (select * from #TEMP)      
       LEFT JOIN Types BrokerType ON BOD.BrokerTypeId = BrokerType.TypeId  
       LEFT JOIN Types_ara T ON BrokerType.TypeId = T.TypeId  
       LEFT JOIN BrokLicenseDetails BLD ON O.OrganizationId = BLD.BrokerOrgId  
       LEFT JOIN DataProfileClassWorkflowStates W ON BOD.StateId = W.StateId  
       LEFT JOIN DataProfileClassWorkflowStates_ara WA ON W.StateId = WA.StateId  
       LEFT JOIN Organizations_ara OA ON OA.OrganizationId = O.OrganizationId  
       LEFT JOIN users U ON u.OrganizationId = o.OrganizationId  
       WHERE O.OrganizationId IN (  
         SELECT *  
         FROM etrade.[fnSplitbigint](@OrganizationIDS)  
         ) --( @OrganizationIDS)--.REPLACE('''',''))            
        AND (  
         (  
          ISNULL(@civilid, '') <> ''  
          AND BOD.CivilId = @civilid  
          )  
         OR (  
          ISNULL(@civilid, '') = ''  
          AND 1 = 1  
          )  
         )  
        AND (  
         (  
          ISNULL(@Tradelicenseno, '') <> ''  
          AND O.TradeLicenseNumber = @Tradelicenseno  
          )  
         OR (  
          ISNULL(@Tradelicenseno, '') = ''  
          AND 1 = 1  
          )  
         )  
        AND (  
         (  
          ISNULL(@BrokerType, '') <> ''  
          AND BrokerType.NAME = @BrokerType  
          )  
         OR (  
          ISNULL(@BrokerType, '') = ''  
          AND 1 = 1  
          )  
         )  
        AND o.StateId IN (  
         SELECT list  
         FROM @stateid  
         )  
        AND isnull(so.ChildOrgId, O.OrganizationId) NOT IN (  
         SELECT OrganizationId  
         FROM etrade.EServiceRequestsDetails  
         WHERE StateId IN (  
           'EServicesRequestDetailsSubmittedState'  
           ,'EServicesRequestDetailsCreatedState'  
           ,'EServiceRequestDetailsProceedState'  
           )  
          AND RequestServicesId = @serviceid  
          AND RequesterUserId = @Userid  
         )  
       )  
    END  
  
    /*  
     Release Bank Guarantee - Revenue Control,  
     Good conduct and behavior- General Directorate of Criminal Evidence,  
     Residency Renew- General Authority for Manpower,  
     Residency Transfer- General Authority for Manpower  
    */  
  
    IF (@serviceid IN (24,25,29,30)) -- All Brokers     
    BEGIN  
		print(' All Brokers      1946');
     SELECT DISTINCT o.StateId  
      ,SO.ChildOrgId  
      ,SO.MainOrgId  
      ,isnull(so.ChildOrgId, O.OrganizationId) 'OrgId'  
      ,isnull(so.ChildOrgId, O.OrganizationId) 'OrganizationId'  
      ,'SubBrokerDetails' AS "TableName"  
      ,BOD.CivilId  
      ,CASE BBD.StateId  
       WHEN 'BrokBGDetailActivatedState'  
        THEN 'ACTIVE'  
       WHEN 'BrokBGDetailDeActivatedState'  
        THEN 'DEACTIVE'  
       ELSE 'INACTIVE'  
       END AS BGStatus  
      ,CASE O.StateId  
       WHEN 'OrganizationsCreatedState'  
        THEN 'ACTIVE'  
       WHEN 'OrganizationsModifyState'  
        THEN 'ACTIVE'  
       WHEN 'OrganizationsNotActivatedState'  
        THEN 'DEACTIVE'  
       WHEN 'OrganizationsTransferredState'  
        THEN 'TRANSFERRED'  
       ELSE 'INACTIVE'  
       END AS AccountStatus  
    --  ,u.AccountStatus AS testaccnt  qasem2024
      ,BrokerType.TypeId  
     -- ,O.TradeLicenseNumber  
	         ,bld.LicenseNo as TradeLicenseNumber  --qasem7-12
      ,ISNULL(OA.NAME, O.NAME) AS BrokerName  
      ,BLD.BrokerFileNumber  
      ,  
      -- ISNULL(T.NAME, BrokerType.NAME) AS BrokerType,BrokerType.Name as EseBrokerType,            
      ISNULL(T.NAME, BrokerType.localdescription) AS BrokerType  
      ,BrokerType.NAME AS EseBrokerType  
      ,ISNULL(BBD.BGNo, '--') AS BankGuaranteeNo  
      ,BBD.BGExpiryDt AS BankGuaranteeExpiryDate  
      ,CONVERT(VARCHAR, BBD.BGExpiryDt, 103) AS 'BankGuaranteeExpiryDatee' -- Abdul Karim            
      --,*                
      ,CONVERT(VARCHAR, BLD.DtOfExpiry, 103) AS LicenseNumberExpiryDate  
     FROM Organizations O  
     LEFT JOIN BrokerOrgDetails BOD ON BOD.BrokerOrgId = O.OrganizationId  
     LEFT JOIN BrokBGDetails BBD ON BBD.BrokerOrgId = BOD.BrokerOrgId  
       -- AND BBD.StateId NOT IN ('BrokBGDetailDeActivatedState')  
		AND BBD.StateId IN ('BrokBGDetailActivatedState','BrokBGDetailExpiredState')   --qasem2024
     LEFT JOIN SubOrg SO ON SO.ChildOrgId = BOD.BrokerOrgId  
     LEFT JOIN Types BrokerType ON BOD.BrokerTypeId = BrokerType.TypeId  
     LEFT JOIN Types_ara T ON BrokerType.TypeId = T.TypeId  
     LEFT JOIN BrokLicenseDetails BLD ON O.OrganizationId = BLD.BrokerOrgId  
     LEFT JOIN DataProfileClassWorkflowStates W ON BOD.StateId = W.StateId  
     LEFT JOIN DataProfileClassWorkflowStates_ara WA ON W.StateId = WA.StateId  
     LEFT JOIN Organizations_ara OA ON OA.OrganizationId = O.OrganizationId  
     LEFT JOIN users U ON u.OrganizationId = o.OrganizationId  
     WHERE O.OrganizationId IN (  
       SELECT *  
       FROM etrade.[fnSplitbigint](@OrganizationIDS)  
       ) --( @OrganizationIDS)--.REPLACE('''',''))            
      AND (  
       (  
        ISNULL(@civilid, '') <> ''  
        AND BOD.CivilId = @civilid  
        )  
       OR (  
        ISNULL(@civilid, '') = ''  
        AND 1 = 1  
        )  
       )  
      AND (  
       (  
        ISNULL(@Tradelicenseno, '') <> ''  
        AND O.TradeLicenseNumber = @Tradelicenseno  
        )  
       OR (  
        ISNULL(@Tradelicenseno, '') = ''  
        AND 1 = 1  
        )  
       )  
      AND (  
       (  
        ISNULL(@BrokerType, '') <> ''  
        AND BrokerType.NAME = @BrokerType  
        )  
       OR (  
        ISNULL(@BrokerType, '') = ''  
        AND 1 = 1  
        )  
       )  
      AND o.StateId IN (  
       SELECT list  
       FROM @stateid  
       )  
      --and  isnull(so.ChildOrgId,O.OrganizationId) in (select * from #TEMP)          
      AND isnull(so.ChildOrgId, O.OrganizationId) NOT IN (  
       SELECT OrganizationId  
       FROM etrade.EServiceRequestsDetails  
       WHERE StateId IN (  
         'EServicesRequestDetailsSubmittedState'  
         ,'EServicesRequestDetailsCreatedState'  
         ,'EServiceRequestDetailsProceedState'  
         )  
        AND RequestServicesId = @serviceid  
        AND RequesterUserId = @Userid  
       )  
    
     UNION  
    
     --all            
     SELECT DISTINCT o.StateId  
      ,SO.ChildOrgId  
      --,isnull(u.UserId,'') as userid            
      ,SO.MainOrgId  
      ,isnull(so.ChildOrgId, O.OrganizationId) 'OrgId'  
      ,isnull(so.ChildOrgId, O.OrganizationId) 'OrganizationId'  
      ,'SubBrokerDetails' AS "TableName"  
      ,BOD.CivilId  
      ,CASE BBD.StateId  
       WHEN 'BrokBGDetailActivatedState'  
        THEN 'ACTIVE'  
       WHEN 'BrokBGDetailDeActivatedState'  
        THEN 'DEACTIVE'  
       ELSE 'INACTIVE'  
       END AS BGStatus  
      ,CASE O.StateId  
       WHEN 'OrganizationsCreatedState'  
        THEN 'ACTIVE'  
       WHEN 'OrganizationsNotActivatedState'  
        THEN 'DEACTIVE'  
       WHEN 'OrganizationsTransferredState'  
        THEN 'TRANSFERRED'  
       WHEN 'OrganizationsModifyState'  
        THEN 'ACTIVE'  
       ELSE 'INACTIVE'  
       END AS AccountStatus  
    --  ,u.AccountStatus AS testaccnt  qasem2024
      ,BrokerType.TypeId  
     -- ,O.TradeLicenseNumber  
	         ,bld.LicenseNo as TradeLicenseNumber  --qasem7-12
      ,ISNULL(OA.NAME, O.NAME) AS BrokerName  
      ,BLD.BrokerFileNumber  
      ,  
      -- ISNULL(T.NAME, BrokerType.NAME) AS BrokerType,BrokerType.Name as EseBrokerType            
      ISNULL(T.NAME, BrokerType.localdescription) AS BrokerType  
      ,BrokerType.NAME AS EseBrokerType  
      ,ISNULL(BBD.BGNo, '--') AS BankGuaranteeNo  
      ,BBD.BGExpiryDt AS BankGuaranteeExpiryDate  
      ,CONVERT(VARCHAR, BBD.BGExpiryDt, 103) AS 'BankGuaranteeExpiryDatee' -- Abdul Karim            
      -- ,*            
      ,CONVERT(VARCHAR, BLD.DtOfExpiry, 103) AS LicenseNumberExpiryDate  
     FROM Organizations O  
     LEFT JOIN BrokerOrgDetails BOD ON BOD.BrokerOrgId = O.OrganizationId  
     LEFT JOIN BrokBGDetails BBD ON BBD.BrokerOrgId = BOD.BrokerOrgId  
       -- AND BBD.StateId NOT IN ('BrokBGDetailDeActivatedState')  
		AND BBD.StateId IN ('BrokBGDetailActivatedState','BrokBGDetailExpiredState')   --qasem2024
     LEFT JOIN SubOrg SO ON SO.ChildOrgId = BOD.BrokerOrgId --  and  isnull(so.ChildOrgId,O.OrganizationId) in (select * from #TEMP)        
     LEFT JOIN Types BrokerType ON BOD.BrokerTypeId = BrokerType.TypeId  
     LEFT JOIN Types_ara T ON BrokerType.TypeId = T.TypeId  
     LEFT JOIN BrokLicenseDetails BLD ON O.OrganizationId = BLD.BrokerOrgId  
     LEFT JOIN DataProfileClassWorkflowStates W ON BOD.StateId = W.StateId  
     LEFT JOIN DataProfileClassWorkflowStates_ara WA ON W.StateId = WA.StateId  
     LEFT JOIN Organizations_ara OA ON OA.OrganizationId = O.OrganizationId  
     LEFT JOIN users U ON u.OrganizationId = o.OrganizationId  
     WHERE SO.MainOrgId IN (  
       SELECT *  
       FROM etrade.[fnSplitbigint](@OrganizationIDS)  
       ) --( @OrganizationIDS)--.REPLACE('''',''))            
      AND (  
       (  
        ISNULL(@civilid, '') <> ''  
        AND BOD.CivilId = @civilid  
        )  
       OR (  
        ISNULL(@civilid, '') = ''  
        AND 1 = 1  
        )  
       )  
      AND (  
       (  
        ISNULL(@Tradelicenseno, '') <> ''  
        AND O.TradeLicenseNumber = @Tradelicenseno  
        )  
       OR (  
        ISNULL(@Tradelicenseno, '') = ''  
        AND 1 = 1  
        )  
       )  
      AND (  
       (  
        ISNULL(@BrokerType, '') <> ''  
        AND BrokerType.NAME = @BrokerType  
        )  
       OR (  
        ISNULL(@BrokerType, '') = ''  
        AND 1 = 1  
        )  
       )  
      AND o.StateId IN (  
       SELECT list  
       FROM @stateid  
       )  
      AND isnull(so.ChildOrgId, O.OrganizationId) NOT IN (  
       SELECT OrganizationId  
       FROM etrade.EServiceRequestsDetails  
       WHERE StateId IN (  
         'EServicesRequestDetailsSubmittedState'  
         ,'EServicesRequestDetailsCreatedState'  
         ,'EServiceRequestDetailsProceedState'  
         )  
        AND RequestServicesId = @serviceid  
        AND RequesterUserId = @Userid  
       )  
     --and o.StateId in (@stateid)    
    
     UNION  
    
     SELECT 'ExamPassedState' StateId  
      ,examcandidateinfoid ChildOrgId  
      ,EAD.ownerorgid MainOrgId  
      ,EAD.ownerorgid 'OrgId'  
      ,EAD.ownerorgid 'OrganizationId'  
      ,'SubBrokerDetails' AS "TableName"  
      ,ED.CivilID CivilId  
      ,  
      --  CASE BBD.StateId           
      --  WHEN 'BrokBGDetailActivatedState' THEN 'ACTIVE'           
      --  WHEN 'BrokBGDetailDeActivatedState' THEN 'DEACTIVE'            
      --  ELSE 'INACTIVE'           
      --END as     
      'ExamPassedState' BGStatus  
      ,  
      --   CASE O.StateId           
      --  WHEN 'OrganizationsCreatedState' THEN 'ACTIVE'           
      --    WHEN 'OrganizationsModifyState' THEN 'ACTIVE'           
      --  WHEN 'OrganizationsNotActivatedState' THEN 'DEACTIVE'            
      --  ELSE           
      --  'INACTIVE'          
      --END AS    
      'ExamPassedState' AccountStatus  
    --  ,u.AccountStatus AS testaccnt  qasem2024
      ,'' TypeId  
      ,'' TradeLicenseNumber  
      ,ED.RequestForName AS BrokerName  
      ,'' BrokerFileNumber  
      ,  
      -- ISNULL(T.NAME, BrokerType.NAME) AS BrokerType,BrokerType.Name as EseBrokerType,          
      ISNULL(T_ara.NAME, T.NAME) AS BrokerType  
      ,T.NAME AS EseBrokerType  
      ,NULL AS BankGuaranteeNo  
      ,NULL AS BankGuaranteeExpiryDate  
      ,NULL AS 'BankGuaranteeExpiryDatee' -- Abdul Karim          
      --,*              
      ,NULL AS LicenseNumberExpiryDate  
     -- E.eservicerequestid,E.stateid,eservicerequestnumber,E.datecreated,E.datemodified,    
     ----examcandidateinfoid,b.examsannouncementdetailsid,examresult,b.stateid,b.ownerorgid,    
     --exammark,EAD.passinggrade,    
     --CASE  WHEN exammark>=EAD.passinggrade THEN 'PASS' ELSE 'FAIL' END AS 'EXAMSTATUS', ED.PassportNo,ED.PassportExpiryDate,ED.CivilID,    
     --ED.CivilIDExpiryDate,ED.Email,ED.MobileNumber,ED.Address    
     FROM ExamCandidateInfo ECI  
     INNER JOIN ExamsAnnouncementDetails EAD ON ECI.ExamsAnnouncementDetailsId = EAD.ExamsAnnouncementDetailsId  
     INNER JOIN ExamsAnnouncements EA ON EAD.ExamsAnnouncementId = EA.ExamsAnnouncementId  
     INNER JOIN etrade.EServiceRequests E ON E.EserviceRequestId = ECI.EServiceRequestId  
     INNER JOIN etrade.EServiceRequestsDetails ED ON E.EserviceRequestId = ED.EserviceRequestId  
     INNER JOIN Types T ON t.TypeId = ed.RequestForUserType  
     LEFT JOIN Types_ara T_ara ON T.TypeId = T_ara.TypeId  
     WHERE e.RequesterUserId = @userid  
      AND eci.ExamResult = (  
       SELECT typeid  
       FROM Types  
       WHERE NAME = 'passed the exam'  
        AND StateId = 'EserviceExamResultsTypesCreatedState'  
       )  
	   	 	 AND ECI.StateId ='ExamCandidateInfoApprovedState' -- rama Kits-54372

      AND eci.DateModified >= dateadd(month, - 6, getdate())  
      AND e.EServiceRequestId NOT IN (  
       SELECT isnull(OrganizationId, 0)  
       FROM etrade.EServiceRequestsDetails  
       WHERE RequestServicesId = @serviceid  
        AND StateId IN (  
         'EServiceRequestDetailsProceedState'  
         ,'EServiceRequestDetailsCompletedState'  
         ,'EServicesRequestDetailsSubmittedState'  
         ,'EServiceRequestDetailsReSubmittedState'  
         )  
       )  
      AND (  
       @serviceid = 28  
       OR @serviceid = 31  
       )  
      AND examcandidateinfoid NOT IN (  
       SELECT isnull(requestforuserid, 0)  
       FROM etrade.eservicerequestsdetails  
       WHERE etrade.eservicerequestsdetails.RequestServicesId = @serviceid  
        AND StateId IN (  
         'EServiceRequestDetailsProceedState'  
         ,'EServiceRequestDetailsCompletedState'  
         ,'EServicesRequestDetailsSubmittedState'  
         ,'EServiceRequestDetailsReSubmittedState'  
         )  
       )  
      AND T.TypeId != 33224591 --exclude general broker for service 28,31    
      --SELECT * FROM types WHERE typeid IN (33224591,33224592,33224593,33237149)--broker types    
     ORDER BY BrokerType.TypeId;  
    END  
  
    /*  
     Change Job Title and Renew Residency- General Authority for Manpower,  
     Change Job Title- With Broker License- General Authority for Manpower  
    */  
    IF (@serviceid IN (27,32)) -- All Brokers       
    BEGIN  
	print(' All Brokers  ');
     SELECT DISTINCT o.StateId  
      ,SO.ChildOrgId  
      ,SO.MainOrgId  
      ,isnull(so.ChildOrgId, O.OrganizationId) 'OrgId'  
      ,isnull(so.ChildOrgId, O.OrganizationId) 'OrganizationId'  
      ,'SubBrokerDetails' AS "TableName"  
      ,BOD.CivilId  
      ,CASE BBD.StateId  
       WHEN 'BrokBGDetailActivatedState'  
        THEN 'ACTIVE'  
       WHEN 'BrokBGDetailDeActivatedState'  
        THEN 'DEACTIVE'  
       ELSE 'INACTIVE'  
       END AS BGStatus  
      ,CASE O.StateId  
       WHEN 'OrganizationsCreatedState'  
        THEN 'ACTIVE'  
       WHEN 'OrganizationsModifyState'  
        THEN 'ACTIVE'  
       WHEN 'OrganizationsNotActivatedState'  
        THEN 'DEACTIVE'  
       WHEN 'OrganizationsTransferredState'  
        THEN 'TRANSFERRED'  
       ELSE 'INACTIVE'  
       END AS AccountStatus  
    --  ,u.AccountStatus AS testaccnt  qasem2024
      ,BrokerType.TypeId  
 -- ,O.TradeLicenseNumber  
	         ,bld.LicenseNo as TradeLicenseNumber  --qasem7-12
			 ,ISNULL(OA.NAME, O.NAME) AS BrokerName  
      ,BLD.BrokerFileNumber  
      ,  
      -- ISNULL(T.NAME, BrokerType.NAME) AS BrokerType,BrokerType.Name as EseBrokerType,            
      ISNULL(T.NAME, BrokerType.localdescription) AS BrokerType  
      ,BrokerType.NAME AS EseBrokerType  
      ,ISNULL(BBD.BGNo, '--') AS BankGuaranteeNo  
      ,BBD.BGExpiryDt AS BankGuaranteeExpiryDate  
      ,CONVERT(VARCHAR, BBD.BGExpiryDt, 103) AS 'BankGuaranteeExpiryDatee' -- Abdul Karim            
      --,*                
      ,CONVERT(VARCHAR, BLD.DtOfExpiry, 103) AS LicenseNumberExpiryDate  
     FROM Organizations O  
     LEFT JOIN BrokerOrgDetails BOD ON BOD.BrokerOrgId = O.OrganizationId  
     LEFT JOIN BrokBGDetails BBD ON BBD.BrokerOrgId = BOD.BrokerOrgId  
       -- AND BBD.StateId NOT IN ('BrokBGDetailDeActivatedState')  
		AND BBD.StateId IN ('BrokBGDetailActivatedState','BrokBGDetailExpiredState')   --qasem2024
     LEFT JOIN SubOrg SO ON SO.ChildOrgId = BOD.BrokerOrgId  
     LEFT JOIN Types BrokerType ON BOD.BrokerTypeId = BrokerType.TypeId  
     LEFT JOIN Types_ara T ON BrokerType.TypeId = T.TypeId  
     LEFT JOIN BrokLicenseDetails BLD ON O.OrganizationId = BLD.BrokerOrgId  
     LEFT JOIN DataProfileClassWorkflowStates W ON BOD.StateId = W.StateId  
     LEFT JOIN DataProfileClassWorkflowStates_ara WA ON W.StateId = WA.StateId  
     LEFT JOIN Organizations_ara OA ON OA.OrganizationId = O.OrganizationId  
     LEFT JOIN users U ON u.OrganizationId = o.OrganizationId  
     WHERE O.OrganizationId IN (  
       SELECT *  
       FROM etrade.[fnSplitbigint](@OrganizationIDS)  
       ) --( @OrganizationIDS)--.REPLACE('''',''))            
      AND (  
       (  
        ISNULL(@civilid, '') <> ''  
        AND BOD.CivilId = @civilid  
        )  
       OR (  
        ISNULL(@civilid, '') = ''  
        AND 1 = 1  
        )  
       )  
      AND (  
       (  
        ISNULL(@Tradelicenseno, '') <> ''  
        AND O.TradeLicenseNumber = @Tradelicenseno  
        )  
       OR (  
        ISNULL(@Tradelicenseno, '') = ''  
        AND 1 = 1  
        )  
       )  
      AND (  
       (  
        ISNULL(@BrokerType, '') <> ''  
        AND BrokerType.NAME = @BrokerType  
        )  
       OR (  
        ISNULL(@BrokerType, '') = ''  
        AND 1 = 1  
        )  
       )  
      AND o.StateId IN (  
       SELECT list  
       FROM @stateid  
       )  
      --and  isnull(so.ChildOrgId,O.OrganizationId) in (select * from #TEMP)          
      AND isnull(so.ChildOrgId, O.OrganizationId) NOT IN (  
       SELECT OrganizationId  
       FROM etrade.EServiceRequestsDetails  
       WHERE StateId IN (  
         'EServicesRequestDetailsSubmittedState'  
         ,'EServicesRequestDetailsCreatedState'  
         ,'EServiceRequestDetailsProceedState'  
         )  
        AND RequestServicesId = @serviceid  
        AND RequesterUserId = @Userid  
       )  
      AND T.TypeId != 33224591  
     --exclude general broker for service 28,31    
     --SELECT * FROM types WHERE typeid IN (33224591,33224592,33224593,33237149)--broker types    
    
     UNION  
    
     --all            
     SELECT DISTINCT o.StateId  
      ,SO.ChildOrgId  
      --,isnull(u.UserId,'') as userid            
      ,SO.MainOrgId  
      ,isnull(so.ChildOrgId, O.OrganizationId) 'OrgId'  
      ,isnull(so.ChildOrgId, O.OrganizationId) 'OrganizationId'  
      ,'SubBrokerDetails' AS "TableName"  
      ,BOD.CivilId  
      ,CASE BBD.StateId  
       WHEN 'BrokBGDetailActivatedState'  
        THEN 'ACTIVE'  
       WHEN 'BrokBGDetailDeActivatedState'  
        THEN 'DEACTIVE'  
       ELSE 'INACTIVE'  
       END AS BGStatus  
      ,CASE O.StateId  
       WHEN 'OrganizationsCreatedState'  
        THEN 'ACTIVE'  
       WHEN 'OrganizationsNotActivatedState'  
        THEN 'DEACTIVE'  
       WHEN 'OrganizationsTransferredState'  
        THEN 'TRANSFERRED'  
       WHEN 'OrganizationsModifyState'  
        THEN 'ACTIVE'  
       ELSE 'INACTIVE'  
       END AS AccountStatus  
    --  ,u.AccountStatus AS testaccnt  qasem2024
      ,BrokerType.TypeId  
 -- ,O.TradeLicenseNumber  
	         ,bld.LicenseNo as TradeLicenseNumber  --qasem7-12
			 ,ISNULL(OA.NAME, O.NAME) AS BrokerName  
      ,BLD.BrokerFileNumber  
      ,  
      -- ISNULL(T.NAME, BrokerType.NAME) AS BrokerType,BrokerType.Name as EseBrokerType            
      ISNULL(T.NAME, BrokerType.localdescription) AS BrokerType  
      ,BrokerType.NAME AS EseBrokerType  
      ,ISNULL(BBD.BGNo, '--') AS BankGuaranteeNo  
      ,BBD.BGExpiryDt AS BankGuaranteeExpiryDate  
      ,CONVERT(VARCHAR, BBD.BGExpiryDt, 103) AS 'BankGuaranteeExpiryDatee' -- Abdul Karim            
      -- ,*            
      ,CONVERT(VARCHAR, BLD.DtOfExpiry, 103) AS LicenseNumberExpiryDate  
     FROM Organizations O  
     LEFT JOIN BrokerOrgDetails BOD ON BOD.BrokerOrgId = O.OrganizationId  
     LEFT JOIN BrokBGDetails BBD ON BBD.BrokerOrgId = BOD.BrokerOrgId  
       -- AND BBD.StateId NOT IN ('BrokBGDetailDeActivatedState')  
		AND BBD.StateId IN ('BrokBGDetailActivatedState','BrokBGDetailExpiredState')   --qasem2024
     LEFT JOIN SubOrg SO ON SO.ChildOrgId = BOD.BrokerOrgId --  and  isnull(so.ChildOrgId,O.OrganizationId) in (select * from #TEMP)        
     LEFT JOIN Types BrokerType ON BOD.BrokerTypeId = BrokerType.TypeId  
     LEFT JOIN Types_ara T ON BrokerType.TypeId = T.TypeId  
     LEFT JOIN BrokLicenseDetails BLD ON O.OrganizationId = BLD.BrokerOrgId  
     LEFT JOIN DataProfileClassWorkflowStates W ON BOD.StateId = W.StateId  
     LEFT JOIN DataProfileClassWorkflowStates_ara WA ON W.StateId = WA.StateId  
     LEFT JOIN Organizations_ara OA ON OA.OrganizationId = O.OrganizationId  
     LEFT JOIN users U ON u.OrganizationId = o.OrganizationId  
     WHERE SO.MainOrgId IN (  
       SELECT *  
       FROM etrade.[fnSplitbigint](@OrganizationIDS)  
       ) --( @OrganizationIDS)--.REPLACE('''',''))            
      AND (  
       (  
        ISNULL(@civilid, '') <> ''  
        AND BOD.CivilId = @civilid  
        )  
       OR (  
        ISNULL(@civilid, '') = ''  
        AND 1 = 1  
        )  
       )  
      AND (  
       (  
        ISNULL(@Tradelicenseno, '') <> ''  
        AND O.TradeLicenseNumber = @Tradelicenseno  
        )  
       OR (  
        ISNULL(@Tradelicenseno, '') = ''  
        AND 1 = 1  
        )  
       )  
      AND (  
       (  
        ISNULL(@BrokerType, '') <> ''  
        AND BrokerType.NAME = @BrokerType  
        )  
       OR (  
        ISNULL(@BrokerType, '') = ''  
        AND 1 = 1  
        )  
       )  
      AND o.StateId IN (  
       SELECT list  
       FROM @stateid  
       )  
      AND isnull(so.ChildOrgId, O.OrganizationId) NOT IN (  
       SELECT OrganizationId  
       FROM etrade.EServiceRequestsDetails  
       WHERE StateId IN (  
         'EServicesRequestDetailsSubmittedState'  
         ,'EServicesRequestDetailsCreatedState'  
         ,'EServiceRequestDetailsProceedState'  
         )  
        AND RequestServicesId = @serviceid  
        AND RequesterUserId = @Userid  
       )  
      --and o.StateId in (@stateid)    
      AND T.TypeId != 33224591  
     --exclude general broker for service 28,31    
     --SELECT * FROM types WHERE typeid IN (33224591,33224592,33224593,33237149)--broker types    
    
     UNION  
    
     SELECT 'ExamPassedState' StateId  
      ,examcandidateinfoid ChildOrgId  
      ,EAD.ownerorgid MainOrgId  
      ,EAD.ownerorgid 'OrgId'  
      ,EAD.ownerorgid 'OrganizationId'  
      ,'SubBrokerDetails' AS "TableName"  
      ,ED.CivilID CivilId  
      ,  
      --  CASE BBD.StateId           
      --  WHEN 'BrokBGDetailActivatedState' THEN 'ACTIVE'           
      --  WHEN 'BrokBGDetailDeActivatedState' THEN 'DEACTIVE'            
      --  ELSE 'INACTIVE'           
      --END as     
      'ExamPassedState' BGStatus  
      ,  
      --   CASE O.StateId           
      --  WHEN 'OrganizationsCreatedState' THEN 'ACTIVE'           
      --    WHEN 'OrganizationsModifyState' THEN 'ACTIVE'           
      --  WHEN 'OrganizationsNotActivatedState' THEN 'DEACTIVE'            
      --  ELSE           
      --  'INACTIVE'          
      --END AS    
      'ExamPassedState' AccountStatus  
    --  ,u.AccountStatus AS testaccnt  qasem2024
      ,'' TypeId  
      ,'' TradeLicenseNumber  
      ,ED.RequestForName AS BrokerName  
      ,'' BrokerFileNumber  
      ,  
      -- ISNULL(T.NAME, BrokerType.NAME) AS BrokerType,BrokerType.Name as EseBrokerType,          
      ISNULL(T_ara.NAME, T.NAME) AS BrokerType  
      ,T.NAME AS EseBrokerType  
      ,NULL AS BankGuaranteeNo  
      ,NULL AS BankGuaranteeExpiryDate  
      ,NULL AS 'BankGuaranteeExpiryDatee' -- Abdul Karim          
      --,*              
      ,NULL AS LicenseNumberExpiryDate  
     -- E.eservicerequestid,E.stateid,eservicerequestnumber,E.datecreated,E.datemodified,    
     ----examcandidateinfoid,b.examsannouncementdetailsid,examresult,b.stateid,b.ownerorgid,    
     --exammark,EAD.passinggrade,    
     --CASE  WHEN exammark>=EAD.passinggrade THEN 'PASS' ELSE 'FAIL' END AS 'EXAMSTATUS', ED.PassportNo,ED.PassportExpiryDate,ED.CivilID,    
     --ED.CivilIDExpiryDate,ED.Email,ED.MobileNumber,ED.Address    
     FROM ExamCandidateInfo ECI  
     INNER JOIN ExamsAnnouncementDetails EAD ON ECI.ExamsAnnouncementDetailsId = EAD.ExamsAnnouncementDetailsId  
     INNER JOIN ExamsAnnouncements EA ON EAD.ExamsAnnouncementId = EA.ExamsAnnouncementId  
     INNER JOIN etrade.EServiceRequests E ON E.EserviceRequestId = ECI.EServiceRequestId  
     INNER JOIN etrade.EServiceRequestsDetails ED ON E.EserviceRequestId = ED.EserviceRequestId  
     INNER JOIN Types T ON t.TypeId = ed.RequestForUserType  
     LEFT JOIN Types_ara T_ara ON T.TypeId = T_ara.TypeId  
     WHERE e.RequesterUserId = @userid  
      AND eci.ExamResult = (  
       SELECT typeid  
       FROM Types  
       WHERE NAME = 'passed the exam'  
        AND StateId = 'EserviceExamResultsTypesCreatedState'  
       )  
	   	 	 AND ECI.StateId ='ExamCandidateInfoApprovedState' -- rama Kits-54372

      AND eci.DateModified >= dateadd(month, - 6, getdate())  
      AND e.EServiceRequestId NOT IN (  
       SELECT isnull(OrganizationId, 0)  
       FROM etrade.EServiceRequestsDetails  
       WHERE RequestServicesId = @serviceid  
        AND StateId IN (  
         'EServiceRequestDetailsProceedState'  
         ,'EServiceRequestDetailsCompletedState'  
         ,'EServicesRequestDetailsSubmittedState'  
         ,'EServiceRequestDetailsReSubmittedState'  
         )  
       )  
      AND (  
       @serviceid = 28  
       OR @serviceid = 31  
       )  
      AND examcandidateinfoid NOT IN (  
       SELECT isnull(requestforuserid, 0)  
       FROM etrade.eservicerequestsdetails  
       WHERE etrade.eservicerequestsdetails.RequestServicesId = @serviceid  
        AND StateId IN (  
         'EServiceRequestDetailsProceedState'  
         ,'EServiceRequestDetailsCompletedState'  
         ,'EServicesRequestDetailsSubmittedState'  
         ,'EServiceRequestDetailsReSubmittedState'  
         )  
       )  
      AND T.TypeId != 33224591 --exclude general broker for service 28,31    
      --SELECT * FROM types WHERE typeid IN (33224591,33224592,33224593,33237149)--broker types    
     ORDER BY BrokerType.TypeId;  
    END  
  
    /*  
     Change Job Title and Transfer Residency- General Authority for Manpower,  
     Change Job Title- General Authority for Manpower  
    */  
    IF (@serviceid IN (28,31))  
    BEGIN  
     PRINT 'exam passedstate 2'  
  
     SELECT 'ExamPassedState' StateId  
      ,examcandidateinfoid ChildOrgId  
      ,EAD.ownerorgid MainOrgId  
      ,EAD.ownerorgid 'OrgId'  
      ,EAD.ownerorgid 'OrganizationId'  
      ,'SubBrokerDetails' AS "TableName"  
      ,ED.CivilID CivilId  
      ,  
      --  CASE BBD.StateId           
      --  WHEN 'BrokBGDetailActivatedState' THEN 'ACTIVE'           
      --  WHEN 'BrokBGDetailDeActivatedState' THEN 'DEACTIVE'            
      --  ELSE 'INACTIVE'           
      --END as     
      'ExamPassedState' BGStatus  
      ,  
      --   CASE O.StateId           
      --  WHEN 'OrganizationsCreatedState' THEN 'ACTIVE'           
      --    WHEN 'OrganizationsModifyState' THEN 'ACTIVE'           
      --  WHEN 'OrganizationsNotActivatedState' THEN 'DEACTIVE'            
      --  ELSE           
      --  'INACTIVE'          
      --END AS    
      'ExamPassedState' AccountStatus  
     -- ,'u.AccountStatus' AS testaccnt  qasem2024
      ,'' TypeId  
      ,'' TradeLicenseNumber  
      ,ED.RequestForName AS BrokerName  
      ,'' BrokerFileNumber  
      ,  
      -- ISNULL(T.NAME, BrokerType.NAME) AS BrokerType,BrokerType.Name as EseBrokerType,          
      ISNULL(T_ara.NAME, T.NAME) AS BrokerType  
      ,T.NAME AS EseBrokerType  
      ,NULL AS BankGuaranteeNo  
      ,NULL AS BankGuaranteeExpiryDate  
      ,NULL AS 'BankGuaranteeExpiryDatee' -- Abdul Karim          
      --,*              
      ,NULL AS LicenseNumberExpiryDate  
     -- E.eservicerequestid,E.stateid,eservicerequestnumber,E.datecreated,E.datemodified,    
     ----examcandidateinfoid,b.examsannouncementdetailsid,examresult,b.stateid,b.ownerorgid,    
     --exammark,EAD.passinggrade,    
     --CASE  WHEN exammark>=EAD.passinggrade THEN 'PASS' ELSE 'FAIL' END AS 'EXAMSTATUS', ED.PassportNo,ED.PassportExpiryDate,ED.CivilID,    
     --ED.CivilIDExpiryDate,ED.Email,ED.MobileNumber,ED.Address    
     FROM ExamCandidateInfo ECI  
     INNER JOIN ExamsAnnouncementDetails EAD ON ECI.ExamsAnnouncementDetailsId = EAD.ExamsAnnouncementDetailsId  
     INNER JOIN ExamsAnnouncements EA ON EAD.ExamsAnnouncementId = EA.ExamsAnnouncementId  
     INNER JOIN etrade.EServiceRequests E ON E.EserviceRequestId = ECI.EServiceRequestId  
     INNER JOIN etrade.EServiceRequestsDetails ED ON E.EserviceRequestId = ED.EserviceRequestId  
     INNER JOIN Types T ON t.TypeId = ed.RequestForUserType  
     LEFT JOIN Types_ara T_ara ON T.TypeId = T_ara.TypeId  
     WHERE e.RequesterUserId = @userid  
      AND eci.ExamResult = (  
       SELECT typeid  
       FROM Types  
       WHERE NAME = 'passed the exam'  
        AND StateId = 'EserviceExamResultsTypesCreatedState'  
       )  
	   	 	 AND ECI.StateId ='ExamCandidateInfoApprovedState' -- rama Kits-54372

      AND eci.DateModified >= dateadd(month, - 6, getdate())  
      AND e.EServiceRequestId NOT IN (  
       SELECT isnull(OrganizationId, 0)  
       FROM etrade.EServiceRequestsDetails  
       WHERE RequestServicesId = @serviceid  
        AND StateId IN (  
         'EServiceRequestDetailsProceedState'  
         ,'EServicesRequestDetailsSubmittedState'  
         ,'EServiceRequestDetailsReSubmittedState'  
         )  
       )  
      AND examcandidateinfoid NOT IN (  
       SELECT isnull(requestforuserid, 0)  
       FROM etrade.EServiceRequestsDetails  
       WHERE RequestServicesId = @serviceid  
        AND StateId IN (  
         'EServiceRequestDetailsProceedState'  
         ,'EServicesRequestDetailsApprovedState'  
         ,'EServicesRequestDetailsSubmittedState'  
         ,'EServiceRequestDetailsReSubmittedState'  
         )  
       )  
      --('EServiceRequestDetailsProceedState','EServiceRequestDetailsCompletedState','EServicesRequestDetailsSubmittedState','EServiceRequestDetailsReSubmittedState'))      AND ( @serviceid=28 OR @serviceid=31)    
      --('EServiceRequestDetailsProceedState','EServiceRequestDetailsCompletedState','EServicesRequestDetailsSubmittedState','EServiceRequestDetailsReSubmittedState'))       
      AND T.TypeId != 33224591 --exclude general broker for service 28,31    
      --SELECT * FROM types WHERE typeid IN (33224591,33224592,33224593,33237149)--broker types    
      AND ED.CIVILID NOT IN (  
       SELECT a.CIVILID  
       FROM ETRADE.ESERVICEREQUESTSDETAILS a  
       INNER JOIN ETRADE.ESERVICEREQUESTS b ON a.eservicerequestid = b.EServiceRequestId  
       WHERE a.requestERuserid = @userid  
        AND RequestServicesId = 17  
        AND a.STATEID NOT IN ('EServicesRequestDetailsDeletedState')  
        AND b.STATEID NOT IN ('EServiceRequestRejectedState')  
        --SELECT CIVILID FROM ETRADE.ESERVICEREQUESTSDETAILS WHERE requestERuserid= @userid  AND   
        --  RequestServicesId=17 AND  STATEID NOT IN ('EServicesRequestDetailsDeletedState')  
       )  
    END  
   END --12.4  
  END --12  
END --1  
    
  
  
  
  
  
