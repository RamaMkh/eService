ALTER TABLE etrade.IndividualAuthorizationRequests
ADD  TemporaryRequestNumber VARCHAR(50) NULL;
Insert into SGCounter Values('TempIndividualAuthorization','IndividualAuthorizationRequests','TemporaryRequestNumber',null,247,null)



CustomsBusinessActivityDocs

ALTER TABLE [etrade].[CustomsBusinessActivityDocuments]
DROP CONSTRAINT FK_CustomsBusinessActivityDocuments_CustomsBusinessActivities;
ALTER TABLE [etrade].[CustomsBusinessActivityDocuments]
DROP CONSTRAINT PK_CustomsBusinessActivityDocuments

ALTER TABLE [etrade].[CustomsBusinessActivityDocuments]
ADD Id INT IDENTITY(1,1) PRIMARY KEY;

ALTER TABLE etrade.CustomsBusinessActivityDocuments
Add   ServiceId  int null;
ALTER TABLE  etrade.CustomsBusinessActivityDocuments
ALTER COLUMN CustomsBusinessActivityId int NULL;

declare @CounterId  int
SELECT @CounterId= Max(cast(TypeId as int))+1 from [Types]
INSERT INTO [dbo].[Types]
           ([TypeId]
           ,[TypeTypeId]
           ,[Name]
           ,[Description]
           ,[DataProfileClassId]
           ,[ParentId]
           ,[Code]
           ,[DateCreated]
           ,[CreatedBy]
           ,[DateModified]
           ,[ModifiedBy]
           ,[StateId]
           ,[OwnerOrgId]
           ,[OwnerLocId]
           ,[LocalDescription]
           ,[IsMandatory])
     VALUES
          (
   @CounterId,
   (select TypeId From types where name='BusinsessPartnerTypes'),
   N'Request Letter By The Organization',
   N'Request Letter By The Organization',
   null, null, null,
   GetDate(),
   null, null, null,
   'EserviceBusinessActivityDocumentTypesCreatedState',
   29588,
   8998,
   N'رسالة الطلب من المؤسسة',
   1
   )
GO


Insert into etrade.CustomsBusinessActivityDocuments(CustomsBusinessActivityId,DocumentTypeId,ServiceId) Values (null,@CounterId,55)

Insert into etrade.CustomsBusinessActivityDocuments(CustomsBusinessActivityId,DocumentTypeId,ServiceId) Values (null,332295773,68)

ALTER view [etrade].[CustomsBusinessActivityDocumentsVw]
AS
Select cba.CustomsBusinessActivityId,cba.DocumentTypeId, Name as [EngName], LocalDescription  as [AraName] ,cba.ServiceId
From etrade.CustomsBusinessActivityDocuments cba
				inner join Types tt on tt.TypeId = cba.DocumentTypeId

GO



USE [MicroclearLight_July23]
GO
/****** Object:  StoredProcedure [etrade].[SubmitUserDeliveryDetails]    Script Date: 12/28/2023 8:43:39 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

 
ALTER proc [etrade].[SubmitUserDeliveryDetails]  
@EserviceRequestId bigint,
@EserviceRequestState VARCHAR(100) as Declare @MCPersonalId BIGINT = 0,@MCUserId VARCHAR(50) = '' Declare @Password varchar(100) = NULL,  @EmailId VARCHAR(50),@EServiceRequestNumber VARCHAR(50) = '' DECLARE @SId  VARCHAR(100) ,@sWhere VARCHAR(1000) 
DECLARE  @RequestNumber VARCHAR(100)

SELECT @MCPersonalId=MCPersonalId,@MCUserId=UserId,@EmailId=EMail  
FROM  [etrade].[EServiceRequestsDetails] 
WHere [EserviceRequestId] = @EserviceRequestId 

Select @RequestNumber =EServiceRequestNumber
FROM  [etrade].[EServiceRequests] 
WHere [EserviceRequestId] = @EserviceRequestId 
IF(@EserviceRequestState = 'Delivered') 

BEGIN 
/*******************-On Delivered action-*******************/ 
SELECT @EServiceRequestNumber = EServiceRequestNumber
FROM eTrade.EServiceRequests 
WHERE EServiceRequestId = @EServiceRequestId 

Select @Password=[Password] from Users where PersonalId=@MCPersonalId 

INSERT INTO [KGACEmailOutSyncQueue] 

( [Sync],[MsgType],[UserId],[Pass],[TOEmailAddress],[CCEmailAddress],[BCCEmailAddress], 
[Consignee],[SampleRequestNo],[DeclNo],[DateCreated],[DateModified], [Status],[msgtypeName],[ConsigneeId],[MailPriority],[TempDeclNumber]) 
VALUES
( 0,'EMAILForESNewUserReqWithPassword',@MCUserId,@Password,@EmailId,'','', @MCPersonalId,'',@EServiceRequestNumber,GETDATE(),GETDATE(), 'Created',NULL, @MCPersonalId,'Normal',@EServiceRequestNumber ) 

UPDATE People SET [StateId]  = 'AwaitingPswdAcknowledgement', [DateModified] = GETDATE(), [ModifiedBy] = 'eservice' Where PersonalId = @MCPersonalId SET  @SId=NEWID() SET  @sWhere='WHERE PersonalId = ''' + CONVERT(VARCHAR, @MCPersonalId) + ''''; EXEC usp_LogInAuditEx @sProfileName='People', @sWhere= @sWhere, @CurrUserId='eservice', @ClientIP = '127.0.0.1', @AppSessionID= @SId UPDATE [dbo].[Users] SET [StateId]  = 'AwaitingPswdAcknowledgement', [DateModified] = GETDATE(), [ModifiedBy] = 'eservice' Where PersonalId = @MCPersonalId SET  @sWhere='Where PersonalId = ''' + CONVERT(VARCHAR(50), @MCPersonalId)+ ''''; EXEC usp_LogInAuditEx @sProfileName='Users', @sWhere= @sWhere, @CurrUserId='eservice', @ClientIP = '127.0.0.1', @AppSessionID = @SId END ELSE BEGIN 

/*******************-On Completion action-*******************/ 
UPDATE [dbo].[People] SET StateId='PeopleActivatedState', ModifiedBy='eservice', DateModified=GETDATE() WHERE PersonalId=@MCPersonalId SET  @SId=NEWID() SET  @sWhere='WHERE PersonalId = ''' + CONVERT(VARCHAR, @MCPersonalId) + ''''; EXEC usp_LogInAuditEx @sProfileName='People', @sWhere= @sWhere, @CurrUserId='eservice', @ClientIP = '127.0.0.1', @AppSessionID= @SId UPDATE [dbo].[Users] SET StateId='UsersActivatedState', AccountStatus='y', ModifiedBy='eservice', DateModified=GETDATE() WHERE PersonalId=@MCPersonalId SET  @sWhere='Where PersonalId = ''' + CONVERT(VARCHAR(50), @MCPersonalId)+ ''''; EXEC usp_LogInAuditEx @sProfileName='Users', @sWhere= @sWhere, @CurrUserId='eservice', @ClientIP = '127.0.0.1', @AppSessionID = @SId END

   UPDATE [dbo].[OrgUserActivities]         
   SET StateId='OrgUserActivitiesActiveState',      
       ModifiedBy='eservice',        
       DateModified=GETDATE()        
   WHERE PersonalId=@MCPersonalId  --@MCPersonalId was already declared in existing code

   SET @sWhere='Where PersonalId ='+ CONVERT(VARCHAR(50), @MCPersonalId);  
  EXEC usp_LogInAuditEx 
			@sProfileName='OrgUserActivities',
			@sWhere= @sWhere,
			@CurrUserId='eservice',
			@ClientIP = '127.0.0.1',
			@AppSessionID = @SId


