
Create PROCEDURE [dbo].[USP_UserBusinessACtivityHistory]
(
@MCPersonalId bigint,
@ActivityId int
)AS 
BEGIN
SELECT 
	CASE When A.StateId='OrgUserActivitiesDeletedState' then 'Removed' else 'Added' END as Action ,
		e.EServiceRequestNumber as RequestNo,
		A.ADate as ActionDate
FROM 
    (SELECT TOP 1 StateId , ActivityId,[$DateTime] AS ADate,eServiceRequestId 
	 FROM [$Orguseractivities] 
	 WHERE PersonalId=@MCPersonalId AND ActivityId=@ActivityId AND StateId='OrgUserActivitiesCreatedState'
   UNION ALL
     SELECT StateId , ActivityId ,DateModified AS ADate,eServiceRequestId 
	  FROM Orguseractivities 
	  WHERE PersonalId=@MCPersonalId AND ActivityId=@ActivityId 
    )A 
JOIN [etrade].[EServiceRequests] e ON e.EServiceRequestId=a.eServiceRequestId
ORDER BY ActionDate 
END
