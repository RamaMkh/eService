
alter PROCEDURE [dbo].[USP_UserBusinessACtivityHistory]
(
@MCPersonalId bigint,
@ActivityIds VARCHAR(MAX)
)AS 
BEGIN
DECLARE @ActivityIdList TABLE (Id INT)

    -- Split the comma-separated string into a table of integers
    INSERT INTO @ActivityIdList (Id)
    SELECT items
    FROM SplitToTable_ara(@ActivityIds, ',')
SELECT 
	CASE When A.StateId='OrgUserActivitiesDeletedState' then 'Removed' else 'Added' END as Action ,
		e.EServiceRequestNumber as RequestNo,
		A.ADate as ActionDate,
		a.ActivityId as ActivityId
FROM 
    (SELECT top 2 StateId , ActivityId,[$DateTime] AS ADate,eServiceRequestId 
	 FROM [$Orguseractivities] 
	 WHERE PersonalId=@MCPersonalId AND ActivityId in(SELECT Id FROM @ActivityIdList) AND StateId='OrgUserActivitiesCreatedState' 
	 and PersonalId in(select personalId from Orguseractivities where stateid = 'OrgUserActivitiesDeletedState' and PersonalId = @MCPersonalId and ActivityId in (SELECT Id FROM @ActivityIdList) )

   UNION ALL
     SELECT StateId , ActivityId ,isnull(DateModified,DateCreated) AS ADate,eServiceRequestId 
	  FROM Orguseractivities 
	  WHERE PersonalId=@MCPersonalId AND ActivityId in(SELECT Id FROM @ActivityIdList)  
    )A 
JOIN [etrade].[EServiceRequests] e ON e.EServiceRequestId=a.eServiceRequestId
ORDER BY ActionDate 
END
